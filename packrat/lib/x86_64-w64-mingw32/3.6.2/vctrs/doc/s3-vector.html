<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">



<title>S3 vectors</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' || rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#header {
text-align: center;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; }  code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">S3 vectors</h1>



<p>This vignette shows you how to create your own S3 vector classes. It focuses on the aspects of making a vector class that every class needs to worry about; you’ll also need to provide methods that actually make the vector useful.</p>
<p>I assume that you’re already familiar with the basic machinery of S3, and the vocabulary I use in Advanced R: constructor, helper, and validator. If not, I recommend reading at least the first two sections of <a href="https://adv-r.hadley.nz/s3.html">the S3 chapter</a> of <em>Advanced R</em>.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1"><span class="kw">library</span>(vctrs)</a></code></pre></div>
<p>This vignette works through five big topics:</p>
<ul>
<li>The basics of creating a new vector class with vctrs.</li>
<li>The coercion and casting system.</li>
<li>The record and list-of types.</li>
<li>Equality and comparison proxies.</li>
<li>Arithmetic operators.</li>
</ul>
<p>They’re collectively demonstrated with a number of simple S3 classes:</p>
<ul>
<li><p>Percent: a double vector that prints as a percentage. This illustrates the basic mechanics of class creation, coercion, and casting.</p></li>
<li><p>Decimal: a double vector that always prints with a fixed number of decimal places. This class has an attribute which needs a little extra care in casts and coercions.</p></li>
<li><p>Cached sum: a double vector that caches the total sum in an attribute. The attribute depends on the data, so needs extra care.</p></li>
<li><p>Rational: a pair of integer vectors that defines a rational number like <code>2 / 3</code>. This introduces you to the record style, and to the equality and comparison operators. It also needs special handling for <code>+</code>, <code>-</code>, and friends.</p></li>
<li><p>Polynomial: a list of integer vectors that define polynomials like <code>1 + x - x^3</code>. Sorting such vectors correctly requires a custom equality method.</p></li>
<li><p>Meter: a numeric vector with meter units. This is the simplest possible class with interesting algebraic properties.</p></li>
<li><p>Period and frequency: a pair of classes represent a period, or it’s inverse, frequency. This allows us to explore more arithmetic operators.</p></li>
</ul>
<div id="basics" class="section level2">
<h2>Basics</h2>
<p>In this section you’ll learn how to create a new vctrs class by calling <code>new_vctr()</code>. This creates an object with class <code>vctrs_vctr</code> which has a number of methods. These are designed to make your life as easy as possible. For example:</p>
<ul>
<li><p>The <code>print()</code> and <code>str()</code> methods are defined in terms of <code>format()</code> so you get a pleasant, consistent display as soon as you’ve made your <code>format()</code> method.</p></li>
<li><p>You can immediately put your new vector class in a data frame because <code>as.data.frame.vctrs_vctr()</code> does the right thing.</p></li>
<li><p>Subsetting (<code>[</code>, <code>[[</code>, <code>$</code>), <code>length&lt;-</code>, and <code>rep()</code> methods automatically preserve attributes because they use <code>vec_restore()</code>. A default <code>vec_restore()</code> works for all classes where the attributes are data-independent, and can easily be customised when the attributes do depend on the data.</p></li>
<li><p>Default subset-assignment methods (<code>[&lt;-</code>, <code>[[&lt;-</code>, <code>$&lt;-</code>) follow the principle that the new values should be coerced to match the existing vector. This gives predictable behaviour and clear error messages.</p></li>
</ul>
<div id="percent-class" class="section level3">
<h3>Percent class</h3>
<p>In this section, I’ll show you how to make a <code>percent</code> class, i.e. a double vector that is printed as a percentage. We start by defining a low-level <a href="https://adv-r.hadley.nz/s3.html#s3-constrcutor">constructor</a> that uses <code>vec_assert()</code> to checks types and/or sizes then calls <code>new_vctr()</code>.</p>
<p><code>percent</code> is built on a double vector of any length and doesn’t have any attributes.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" title="1">new_percent &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">x =</span> <span class="kw">double</span>()) {</a>
<a class="sourceLine" id="cb2-2" title="2">  <span class="kw">vec_assert</span>(x, <span class="kw">double</span>())</a>
<a class="sourceLine" id="cb2-3" title="3">  <span class="kw">new_vctr</span>(x, <span class="dt">class =</span> <span class="st">&quot;vctrs_percent&quot;</span>)</a>
<a class="sourceLine" id="cb2-4" title="4">}</a>
<a class="sourceLine" id="cb2-5" title="5"></a>
<a class="sourceLine" id="cb2-6" title="6">x &lt;-<span class="st"> </span><span class="kw">new_percent</span>(<span class="kw">c</span>(<span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dt">length =</span> <span class="dv">4</span>), <span class="ot">NA</span>))</a>
<a class="sourceLine" id="cb2-7" title="7">x</a>
<a class="sourceLine" id="cb2-8" title="8"><span class="co">#&gt; &lt;vctrs_percent[5]&gt;</span></a>
<a class="sourceLine" id="cb2-9" title="9"><span class="co">#&gt; [1] 0.0000000 0.3333333 0.6666667 1.0000000        NA</span></a>
<a class="sourceLine" id="cb2-10" title="10"></a>
<a class="sourceLine" id="cb2-11" title="11"><span class="kw">str</span>(x)</a>
<a class="sourceLine" id="cb2-12" title="12"><span class="co">#&gt;  vctrs_pr [1:5] 0.0000000, 0.3333333, 0.6666667, 1.0000000,        NA</span></a></code></pre></div>
<p>Note that we prefix the name of the class with the name of the package. This prevents conflicting definitions between packages. For packages that implement only one class (such as <a href="https://blob.tidyverse.org/">blob</a>), it’s fine to use the package name without prefix as the class name.</p>
<p>We then follow up with a user friendly <a href="https://adv-r.hadley.nz/s3.html#helpers">helper</a>. Here we’ll use <code>vec_cast()</code> to allow it to accept anything coercible to a double:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" title="1">percent &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">x =</span> <span class="kw">double</span>()) {</a>
<a class="sourceLine" id="cb3-2" title="2">  x &lt;-<span class="st"> </span><span class="kw">vec_cast</span>(x, <span class="kw">double</span>())</a>
<a class="sourceLine" id="cb3-3" title="3">  <span class="kw">new_percent</span>(x)</a>
<a class="sourceLine" id="cb3-4" title="4">}</a></code></pre></div>
<p>Before you go on, check that user-friendly constructor returns a zero-length vector when called with no arguments. This makes it easy to use as a prototype.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" title="1"><span class="kw">new_percent</span>()</a>
<a class="sourceLine" id="cb4-2" title="2"><span class="co">#&gt; &lt;vctrs_percent[0]&gt;</span></a>
<a class="sourceLine" id="cb4-3" title="3"><span class="kw">percent</span>()</a>
<a class="sourceLine" id="cb4-4" title="4"><span class="co">#&gt; &lt;vctrs_percent[0]&gt;</span></a></code></pre></div>
<p>Add a call to <code>setOldClass()</code> for compatibility with the S4 system:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1"><span class="co">#&#39; @importFrom methods setOldClass</span></a>
<a class="sourceLine" id="cb5-2" title="2">methods<span class="op">::</span><span class="kw">setOldClass</span>(<span class="kw">c</span>(<span class="st">&quot;vctrs_percent&quot;</span>, <span class="st">&quot;vctrs_vctr&quot;</span>))</a></code></pre></div>
<p>For the convenience of your users, consider implementing an <code>is_percent()</code> function:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1">is_percent &lt;-<span class="st"> </span><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb6-2" title="2">  <span class="kw">inherits</span>(x, <span class="st">&quot;vctrs_percent&quot;</span>)</a>
<a class="sourceLine" id="cb6-3" title="3">}</a></code></pre></div>
</div>
<div id="format-method" class="section level3">
<h3><code>format()</code> method</h3>
<p>The first method for every class should almost always be a <code>format()</code> method. This should return a character vector the same length as <code>x</code>. The easiest way to do this is to rely on one of R’s low-level formatting functions like <code>formatC()</code>:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" title="1">format.vctrs_percent &lt;-<span class="st"> </span><span class="cf">function</span>(x, ...) {</a>
<a class="sourceLine" id="cb7-2" title="2">  out &lt;-<span class="st"> </span><span class="kw">formatC</span>(<span class="kw">signif</span>(<span class="kw">vec_data</span>(x) <span class="op">*</span><span class="st"> </span><span class="dv">100</span>, <span class="dv">3</span>))</a>
<a class="sourceLine" id="cb7-3" title="3">  out[<span class="kw">is.na</span>(x)] &lt;-<span class="st"> </span><span class="ot">NA</span></a>
<a class="sourceLine" id="cb7-4" title="4">  out[<span class="op">!</span><span class="kw">is.na</span>(x)] &lt;-<span class="st"> </span><span class="kw">paste0</span>(out[<span class="op">!</span><span class="kw">is.na</span>(x)], <span class="st">&quot;%&quot;</span>)</a>
<a class="sourceLine" id="cb7-5" title="5">  out</a>
<a class="sourceLine" id="cb7-6" title="6">}</a></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" title="1">x</a>
<a class="sourceLine" id="cb8-2" title="2"><span class="co">#&gt; &lt;vctrs_percent[5]&gt;</span></a>
<a class="sourceLine" id="cb8-3" title="3"><span class="co">#&gt; [1] 0%    33.3% 66.7% 100%  &lt;NA&gt;</span></a></code></pre></div>
<p>(Note the use of <code>vec_data()</code> so <code>format()</code> doesn’t get stuck in an infinite loop, and that I take a little care to not convert <code>NA</code> to <code>&quot;NA&quot;</code>; this leads to better printing.)</p>
<p>The format method is also used by data frames, tibbles, and <code>str()</code>:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" title="1"><span class="kw">data.frame</span>(x)</a>
<a class="sourceLine" id="cb9-2" title="2"><span class="co">#&gt;       x</span></a>
<a class="sourceLine" id="cb9-3" title="3"><span class="co">#&gt; 1    0%</span></a>
<a class="sourceLine" id="cb9-4" title="4"><span class="co">#&gt; 2 33.3%</span></a>
<a class="sourceLine" id="cb9-5" title="5"><span class="co">#&gt; 3 66.7%</span></a>
<a class="sourceLine" id="cb9-6" title="6"><span class="co">#&gt; 4  100%</span></a>
<a class="sourceLine" id="cb9-7" title="7"><span class="co">#&gt; 5  &lt;NA&gt;</span></a></code></pre></div>
<p>For optimal display, I recommend also defining an abbreviated type name, which should be 4-5 letters for commonly used vectors. This is used in tibbles and in <code>str()</code>:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" title="1">vec_ptype_abbr.vctrs_percent &lt;-<span class="st"> </span><span class="cf">function</span>(x, ...) {</a>
<a class="sourceLine" id="cb10-2" title="2">  <span class="st">&quot;prcnt&quot;</span></a>
<a class="sourceLine" id="cb10-3" title="3">}</a>
<a class="sourceLine" id="cb10-4" title="4"></a>
<a class="sourceLine" id="cb10-5" title="5">tibble<span class="op">::</span><span class="kw">tibble</span>(x)</a>
<a class="sourceLine" id="cb10-6" title="6"><span class="co">#&gt; # A tibble: 5 x 1</span></a>
<a class="sourceLine" id="cb10-7" title="7"><span class="co">#&gt;         x</span></a>
<a class="sourceLine" id="cb10-8" title="8"><span class="co">#&gt;   &lt;prcnt&gt;</span></a>
<a class="sourceLine" id="cb10-9" title="9"><span class="co">#&gt; 1      0%</span></a>
<a class="sourceLine" id="cb10-10" title="10"><span class="co">#&gt; 2   33.3%</span></a>
<a class="sourceLine" id="cb10-11" title="11"><span class="co">#&gt; 3   66.7%</span></a>
<a class="sourceLine" id="cb10-12" title="12"><span class="co">#&gt; 4    100%</span></a>
<a class="sourceLine" id="cb10-13" title="13"><span class="co">#&gt; 5      NA</span></a>
<a class="sourceLine" id="cb10-14" title="14"></a>
<a class="sourceLine" id="cb10-15" title="15"><span class="kw">str</span>(x)</a>
<a class="sourceLine" id="cb10-16" title="16"><span class="co">#&gt;  prcnt [1:5] 0%, 33.3%, 66.7%, 100%, &lt;NA&gt;</span></a></code></pre></div>
<p>If you need more control over printing in tibbles, implement a method for <code>pillar::pillar_shaft()</code>. See <a href="https://tibble.tidyverse.org/articles/extending.html" class="uri">https://tibble.tidyverse.org/articles/extending.html</a> for details.</p>
</div>
</div>
<div id="casting-and-coercion" class="section level2">
<h2>Casting and coercion</h2>
<p>The next set of methods you are likely to need are those related to coercion and casting. Coercion and casting are two sides of the same coin: changing the prototype of an existing object. When the change happens <em>implicitly</em> (e.g in <code>c()</code>) we call it <strong>coercion</strong>; when the change happens <em>explicitly</em> (e.g. with <code>as.integer(x)</code>), we call it <strong>casting</strong>.</p>
<p>One of the main goals of vctrs is to put coercion and casting on a robust theoretical footing so it’s possible to make accurate predictions about what (e.g.) <code>c(x, y)</code> should do when <code>x</code> and <code>y</code> have different prototypes. vctrs achieves this goal through two generics:</p>
<ul>
<li><p><code>vec_ptype2(x, y)</code> defines possible set of coercions. It returns a prototype if <code>x</code> and <code>y</code> can be safely coerced to the same prototype; otherwise it returns an error. The set of automatic coercions is usually quite small because too many tend to make code harder to reason about and silently propagate mistakes.</p></li>
<li><p><code>vec_cast(x, to)</code> defines the possible sets of casts. It returns <code>x</code> translated to have prototype <code>to</code>, or throws an error if the conversion isn’t possible. The set of possible casts is a superset of possible coercions because they’re requested explicitly.</p></li>
</ul>
<div id="double-dispatch" class="section level3">
<h3>Double dispatch</h3>
<p>Both generics use <strong><a href="https://en.wikipedia.org/wiki/Double_dispatch">double dispatch</a></strong> which means that the implementation is selected based on the class of two arguments, not just one. S3 does not natively support double dispatch, but we can implement with a trick: doing single dispatch twice. In practice, this means you end up with method names with two classes, like <code>vec_ptype2.foo.bar()</code>, and you need a little boilerplate to get started. The key idea that makes double dispatch work without any modifications to S3 is that a function (like <code>vec_ptype2.foo()</code>) can be both an S3 generic and an S3 method.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" title="1">vec_ptype2.MYCLASS &lt;-<span class="st"> </span><span class="cf">function</span>(x, y, ...) <span class="kw">UseMethod</span>(<span class="st">&quot;vec_ptype2.MYCLASS&quot;</span>, y)</a>
<a class="sourceLine" id="cb11-2" title="2">vec_ptype2.MYCLASS.default &lt;-<span class="st"> </span><span class="cf">function</span>(x, y, ..., <span class="dt">x_arg =</span> <span class="st">&quot;x&quot;</span>, <span class="dt">y_arg =</span> <span class="st">&quot;y&quot;</span>) {</a>
<a class="sourceLine" id="cb11-3" title="3">  <span class="kw">vec_default_ptype2</span>(x, y, <span class="dt">x_arg =</span> x_arg, <span class="dt">y_arg =</span> y_arg)</a>
<a class="sourceLine" id="cb11-4" title="4">}</a>
<a class="sourceLine" id="cb11-5" title="5"></a>
<a class="sourceLine" id="cb11-6" title="6">vec_cast.MYCLASS &lt;-<span class="st"> </span><span class="cf">function</span>(x, to, ...) <span class="kw">UseMethod</span>(<span class="st">&quot;vec_cast.MYCLASS&quot;</span>)</a>
<a class="sourceLine" id="cb11-7" title="7">vec_cast.MYCLASS.default &lt;-<span class="st"> </span><span class="cf">function</span>(x, to, ...) <span class="kw">vec_default_cast</span>(x, to)</a></code></pre></div>
<p>We’ll discuss what this boilerplate does in the upcoming sections; just remember you’ll always need to copy and paste it when creating a new S3 class.</p>
</div>
<div id="percent" class="section level3">
<h3>Percent class</h3>
<p>We’ll make our percent class coercible back and forth with double vectors. I’ll start with the boilerplate for <code>vec_ptype2()</code>:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" title="1">vec_ptype2.vctrs_percent &lt;-<span class="st"> </span><span class="cf">function</span>(x, y, ...) <span class="kw">UseMethod</span>(<span class="st">&quot;vec_ptype2.vctrs_percent&quot;</span>, y)</a>
<a class="sourceLine" id="cb12-2" title="2">vec_ptype2.vctrs_percent.default &lt;-<span class="st"> </span><span class="cf">function</span>(x, y, ..., <span class="dt">x_arg =</span> <span class="st">&quot;x&quot;</span>, <span class="dt">y_arg =</span> <span class="st">&quot;y&quot;</span>) {</a>
<a class="sourceLine" id="cb12-3" title="3">  <span class="kw">vec_default_ptype2</span>(x, y, <span class="dt">x_arg =</span> x_arg, <span class="dt">y_arg =</span> y_arg)</a>
<a class="sourceLine" id="cb12-4" title="4">}</a></code></pre></div>
<p>The default method provides a user friendly error message if the coercion doesn’t exist, and makes sure <code>NA</code> is handled in a standard way. <code>NA</code> is technically a logical vector, but we want to stand in for a missing value of any type.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" title="1"><span class="kw">vec_ptype2</span>(<span class="st">&quot;bogus&quot;</span>, <span class="kw">percent</span>())</a>
<a class="sourceLine" id="cb13-2" title="2"><span class="co">#&gt; No common type for `x` &lt;character&gt; and `y` &lt;vctrs_percent&gt;.</span></a>
<a class="sourceLine" id="cb13-3" title="3"><span class="kw">vec_ptype2</span>(<span class="kw">percent</span>(), <span class="ot">NA</span>)</a>
<a class="sourceLine" id="cb13-4" title="4"><span class="co">#&gt; &lt;vctrs_percent[0]&gt;</span></a>
<a class="sourceLine" id="cb13-5" title="5"><span class="kw">vec_ptype2</span>(<span class="ot">NA</span>, <span class="kw">percent</span>())</a>
<a class="sourceLine" id="cb13-6" title="6"><span class="co">#&gt; &lt;vctrs_percent[0]&gt;</span></a></code></pre></div>
<p>Next, start by saying that a <code>vctrs_percent</code> combined with a <code>vctrs_percent</code> yields a <code>vctrs_percent</code>, which we indicate by returning a prototype generated by the constructor.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" title="1">vec_ptype2.vctrs_percent.vctrs_percent &lt;-<span class="st"> </span><span class="cf">function</span>(x, y, ...) <span class="kw">new_percent</span>()</a></code></pre></div>
<p>Next we define methods that say that combining a <code>percent</code> and double should yield a <code>double</code>. We avoid returning a <code>percent</code> here, because errors in the scale (1 vs. 0.01) are more obvious with raw numbers.</p>
<p>Because double dispatch is a bit of a hack, we need to provide two methods. It’s your responsibility to ensure that each pair return the same result: if they don’t you will get weird and unpredictable behaviour.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" title="1">vec_ptype2.vctrs_percent.double &lt;-<span class="st"> </span><span class="cf">function</span>(x, y, ...) <span class="kw">double</span>()</a>
<a class="sourceLine" id="cb15-2" title="2">vec_ptype2.double.vctrs_percent &lt;-<span class="st"> </span><span class="cf">function</span>(x, y, ...) <span class="kw">double</span>()</a></code></pre></div>
<p>We can check that we’ve implemented this correctly with <code>vec_ptype_show()</code>:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" title="1"><span class="kw">vec_ptype_show</span>(<span class="kw">percent</span>(), <span class="kw">double</span>(), <span class="kw">percent</span>())</a>
<a class="sourceLine" id="cb16-2" title="2"><span class="co">#&gt; Prototype: &lt;double&gt;</span></a>
<a class="sourceLine" id="cb16-3" title="3"><span class="co">#&gt; 0. (                 , &lt;vctrs_percent&gt; ) = &lt;vctrs_percent&gt;</span></a>
<a class="sourceLine" id="cb16-4" title="4"><span class="co">#&gt; 1. ( &lt;vctrs_percent&gt; , &lt;double&gt;        ) = &lt;double&gt;       </span></a>
<a class="sourceLine" id="cb16-5" title="5"><span class="co">#&gt; 2. ( &lt;double&gt;        , &lt;vctrs_percent&gt; ) = &lt;double&gt;</span></a></code></pre></div>
<p>Next we implement explicit casting, again starting with the boilerplate:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" title="1">vec_cast.vctrs_percent &lt;-<span class="st"> </span><span class="cf">function</span>(x, to, ...) <span class="kw">UseMethod</span>(<span class="st">&quot;vec_cast.vctrs_percent&quot;</span>)</a>
<a class="sourceLine" id="cb17-2" title="2">vec_cast.vctrs_percent.default &lt;-<span class="st"> </span><span class="cf">function</span>(x, to, ...) <span class="kw">vec_default_cast</span>(x, to)</a></code></pre></div>
<p>Then providing a method to coerce a percent to a percent:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" title="1">vec_cast.vctrs_percent.vctrs_percent &lt;-<span class="st"> </span><span class="cf">function</span>(x, to, ...) x</a></code></pre></div>
<p>And then for converting back and forth between doubles. To convert a double to a percent we use the <code>percent()</code> helper (not the constructor; this is unvalidated user input). To convert a <code>percent</code> to a double, we strip the attributes.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" title="1">vec_cast.vctrs_percent.double &lt;-<span class="st"> </span><span class="cf">function</span>(x, to, ...) <span class="kw">percent</span>(x)</a>
<a class="sourceLine" id="cb19-2" title="2">vec_cast.double.vctrs_percent &lt;-<span class="st"> </span><span class="cf">function</span>(x, to, ...) <span class="kw">vec_data</span>(x)</a></code></pre></div>
<p>Then we can check this works with <code>vec_cast()</code>:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" title="1"><span class="kw">vec_cast</span>(<span class="fl">0.5</span>, <span class="kw">percent</span>())</a>
<a class="sourceLine" id="cb20-2" title="2"><span class="co">#&gt; &lt;vctrs_percent[1]&gt;</span></a>
<a class="sourceLine" id="cb20-3" title="3"><span class="co">#&gt; [1] 50%</span></a>
<a class="sourceLine" id="cb20-4" title="4"><span class="kw">vec_cast</span>(<span class="kw">percent</span>(<span class="fl">0.5</span>), <span class="kw">double</span>())</a>
<a class="sourceLine" id="cb20-5" title="5"><span class="co">#&gt; [1] 0.5</span></a></code></pre></div>
<p>Once you’ve implemented <code>vec_ptype2()</code> and <code>vec_cast()</code> you get <code>vec_c()</code>, <code>[&lt;-</code> and <code>[[&lt;-</code> implementations for free.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" title="1"><span class="kw">vec_c</span>(<span class="kw">percent</span>(<span class="fl">0.5</span>), <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb21-2" title="2"><span class="co">#&gt; [1] 0.5 1.0</span></a>
<a class="sourceLine" id="cb21-3" title="3"><span class="kw">vec_c</span>(<span class="ot">NA</span>, <span class="kw">percent</span>(<span class="fl">0.5</span>))</a>
<a class="sourceLine" id="cb21-4" title="4"><span class="co">#&gt; &lt;vctrs_percent[2]&gt;</span></a>
<a class="sourceLine" id="cb21-5" title="5"><span class="co">#&gt; [1] &lt;NA&gt; 50%</span></a>
<a class="sourceLine" id="cb21-6" title="6"><span class="co"># but</span></a>
<a class="sourceLine" id="cb21-7" title="7"><span class="kw">vec_c</span>(<span class="ot">TRUE</span>, <span class="kw">percent</span>(<span class="fl">0.5</span>))</a>
<a class="sourceLine" id="cb21-8" title="8"><span class="co">#&gt; No common type for `..1` &lt;logical&gt; and `..2` &lt;vctrs_percent&gt;.</span></a>
<a class="sourceLine" id="cb21-9" title="9"></a>
<a class="sourceLine" id="cb21-10" title="10">x &lt;-<span class="st"> </span><span class="kw">percent</span>(<span class="kw">c</span>(<span class="fl">0.5</span>, <span class="dv">1</span>, <span class="dv">2</span>))</a>
<a class="sourceLine" id="cb21-11" title="11">x[<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>] &lt;-<span class="st"> </span><span class="dv">2</span><span class="op">:</span><span class="dv">1</span></a>
<a class="sourceLine" id="cb21-12" title="12"><span class="co">#&gt; No common type for `x` &lt;integer&gt; and `value` &lt;vctrs_percent&gt;.</span></a>
<a class="sourceLine" id="cb21-13" title="13">x[[<span class="dv">3</span>]] &lt;-<span class="st"> </span><span class="fl">0.5</span></a>
<a class="sourceLine" id="cb21-14" title="14">x</a>
<a class="sourceLine" id="cb21-15" title="15"><span class="co">#&gt; &lt;vctrs_percent[3]&gt;</span></a>
<a class="sourceLine" id="cb21-16" title="16"><span class="co">#&gt; [1] 50%  100% 50%</span></a></code></pre></div>
<p>You’ll also get mostly correct behaviour for <code>c()</code>. The exception is when you use <code>c()</code> with a base R class:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" title="1"><span class="co"># Correct</span></a>
<a class="sourceLine" id="cb22-2" title="2"><span class="kw">c</span>(<span class="kw">percent</span>(<span class="fl">0.5</span>), <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb22-3" title="3"><span class="co">#&gt; [1] 0.5 1.0</span></a>
<a class="sourceLine" id="cb22-4" title="4"><span class="kw">c</span>(<span class="kw">percent</span>(<span class="fl">0.5</span>), <span class="kw">factor</span>(<span class="dv">1</span>))</a>
<a class="sourceLine" id="cb22-5" title="5"><span class="co">#&gt; No common type for `..1` &lt;vctrs_percent&gt; and `..2` &lt;factor&lt;5b58e&gt;&gt;.</span></a>
<a class="sourceLine" id="cb22-6" title="6"></a>
<a class="sourceLine" id="cb22-7" title="7"><span class="co"># Incorrect</span></a>
<a class="sourceLine" id="cb22-8" title="8"><span class="kw">c</span>(<span class="kw">factor</span>(<span class="dv">1</span>), <span class="kw">percent</span>(<span class="fl">0.5</span>))</a>
<a class="sourceLine" id="cb22-9" title="9"><span class="co">#&gt; [1] 1.0 0.5</span></a></code></pre></div>
<p>Unfortunately there’s no way to fix this problem with the current design of <code>c()</code>.</p>
<p>Again, as a convenience, consider providing an <code>as_percent()</code> function that makes use of the casts defined in your <code>vec_cast.vctrs_percent()</code> methods:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" title="1">as_percent &lt;-<span class="st"> </span><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb23-2" title="2">  <span class="kw">vec_cast</span>(x, <span class="kw">new_percent</span>())</a>
<a class="sourceLine" id="cb23-3" title="3">}</a></code></pre></div>
</div>
<div id="decimal-class" class="section level3">
<h3>Decimal class</h3>
<p>Now that you’ve seen the basics with a very simple S3 class, we’ll gradually explore more complicated scenarios. This section creates a <code>decimal</code> class that prints with the specified number of decimal places. This is very similar to <code>percent</code> but now the class needs an attribute: the number of decimal places to display (an integer vector of length 1).</p>
<p>We start of as before, defining a low-level constructor, a user-friendly constructor, a <code>format()</code> method, and a <code>vec_ptype_abbr()</code>. Note that additional object attributes are simply passed along to <code>new_vctr()</code>:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" title="1">new_decimal &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">x =</span> <span class="kw">double</span>(), <span class="dt">digits =</span> 2L) {</a>
<a class="sourceLine" id="cb24-2" title="2">  <span class="kw">vec_assert</span>(x, <span class="dt">ptype =</span> <span class="kw">double</span>())</a>
<a class="sourceLine" id="cb24-3" title="3">  <span class="kw">vec_assert</span>(digits, <span class="dt">ptype =</span> <span class="kw">integer</span>(), <span class="dt">size =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb24-4" title="4"></a>
<a class="sourceLine" id="cb24-5" title="5">  <span class="kw">new_vctr</span>(x, <span class="dt">digits =</span> digits, <span class="dt">class =</span> <span class="st">&quot;vctrs_decimal&quot;</span>)</a>
<a class="sourceLine" id="cb24-6" title="6">}</a>
<a class="sourceLine" id="cb24-7" title="7"></a>
<a class="sourceLine" id="cb24-8" title="8">decimal &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">x =</span> <span class="kw">double</span>(), <span class="dt">digits =</span> 2L) {</a>
<a class="sourceLine" id="cb24-9" title="9">  x &lt;-<span class="st"> </span><span class="kw">vec_cast</span>(x, <span class="kw">double</span>())</a>
<a class="sourceLine" id="cb24-10" title="10">  digits &lt;-<span class="st"> </span><span class="kw">vec_recycle</span>(<span class="kw">vec_cast</span>(digits, <span class="kw">integer</span>()), 1L)</a>
<a class="sourceLine" id="cb24-11" title="11"></a>
<a class="sourceLine" id="cb24-12" title="12">  <span class="kw">new_decimal</span>(x, <span class="dt">digits =</span> digits)</a>
<a class="sourceLine" id="cb24-13" title="13">}</a>
<a class="sourceLine" id="cb24-14" title="14"></a>
<a class="sourceLine" id="cb24-15" title="15">digits &lt;-<span class="st"> </span><span class="cf">function</span>(x) <span class="kw">attr</span>(x, <span class="st">&quot;digits&quot;</span>)</a>
<a class="sourceLine" id="cb24-16" title="16"></a>
<a class="sourceLine" id="cb24-17" title="17">format.vctrs_decimal &lt;-<span class="st"> </span><span class="cf">function</span>(x, ...) {</a>
<a class="sourceLine" id="cb24-18" title="18">  <span class="kw">sprintf</span>(<span class="kw">paste0</span>(<span class="st">&quot;%-0.&quot;</span>, <span class="kw">digits</span>(x), <span class="st">&quot;f&quot;</span>), x)</a>
<a class="sourceLine" id="cb24-19" title="19">}</a>
<a class="sourceLine" id="cb24-20" title="20"></a>
<a class="sourceLine" id="cb24-21" title="21">vec_ptype_abbr.vctrs_decimal &lt;-<span class="st"> </span><span class="cf">function</span>(x, ...) {</a>
<a class="sourceLine" id="cb24-22" title="22">  <span class="kw">paste0</span>(<span class="st">&quot;dec&quot;</span>)</a>
<a class="sourceLine" id="cb24-23" title="23">}</a>
<a class="sourceLine" id="cb24-24" title="24"></a>
<a class="sourceLine" id="cb24-25" title="25">x &lt;-<span class="st"> </span><span class="kw">decimal</span>(<span class="kw">runif</span>(<span class="dv">10</span>), 1L)</a>
<a class="sourceLine" id="cb24-26" title="26">x</a>
<a class="sourceLine" id="cb24-27" title="27"><span class="co">#&gt; &lt;vctrs_decimal[10]&gt;</span></a>
<a class="sourceLine" id="cb24-28" title="28"><span class="co">#&gt;  [1] 0.1 0.8 0.6 0.2 0.0 0.5 0.5 0.3 0.7 0.8</span></a></code></pre></div>
<p>Note that I provide a little helper to extract the <code>digits</code> attribute. This makes the code a little easier to read, and should not be exported.</p>
<p>By default, vctrs assumes that attributes are independent of the data, and so are automatically preserved. You’ll see what to do if the attributes are data dependent in the next section.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" title="1">x[<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>]</a>
<a class="sourceLine" id="cb25-2" title="2"><span class="co">#&gt; &lt;vctrs_decimal[2]&gt;</span></a>
<a class="sourceLine" id="cb25-3" title="3"><span class="co">#&gt; [1] 0.1 0.8</span></a>
<a class="sourceLine" id="cb25-4" title="4">x[[<span class="dv">1</span>]]</a>
<a class="sourceLine" id="cb25-5" title="5"><span class="co">#&gt; &lt;vctrs_decimal[1]&gt;</span></a>
<a class="sourceLine" id="cb25-6" title="6"><span class="co">#&gt; [1] 0.1</span></a></code></pre></div>
<p>For the sake of exposition, we’ll assume that <code>digits</code> is an important attribute of the class, and should be included in the full type:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb26-1" title="1">vec_ptype_full.vctrs_decimal &lt;-<span class="st"> </span><span class="cf">function</span>(x, ...) {</a>
<a class="sourceLine" id="cb26-2" title="2">  <span class="kw">paste0</span>(<span class="st">&quot;decimal&lt;&quot;</span>, <span class="kw">digits</span>(x), <span class="st">&quot;&gt;&quot;</span>)</a>
<a class="sourceLine" id="cb26-3" title="3">}</a>
<a class="sourceLine" id="cb26-4" title="4"></a>
<a class="sourceLine" id="cb26-5" title="5">x</a>
<a class="sourceLine" id="cb26-6" title="6"><span class="co">#&gt; &lt;decimal&lt;1&gt;[10]&gt;</span></a>
<a class="sourceLine" id="cb26-7" title="7"><span class="co">#&gt;  [1] 0.1 0.8 0.6 0.2 0.0 0.5 0.5 0.3 0.7 0.8</span></a></code></pre></div>
<p>Now consider <code>vec_cast()</code> and <code>vec_ptype2()</code>. I start with the standard recipes:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" title="1">vec_ptype2.vctrs_decimal &lt;-<span class="st"> </span><span class="cf">function</span>(x, y, ...) <span class="kw">UseMethod</span>(<span class="st">&quot;vec_ptype2.vctrs_decimal&quot;</span>)</a>
<a class="sourceLine" id="cb27-2" title="2">vec_ptype2.vctrs_decimal.default &lt;-<span class="st"> </span><span class="cf">function</span>(x, y, ..., <span class="dt">x_arg =</span> <span class="st">&quot;x&quot;</span>, <span class="dt">y_arg =</span> <span class="st">&quot;y&quot;</span>) {</a>
<a class="sourceLine" id="cb27-3" title="3">  <span class="kw">vec_default_ptype2</span>(x, y, <span class="dt">x_arg =</span> x_arg, <span class="dt">y_arg =</span> y_arg)</a>
<a class="sourceLine" id="cb27-4" title="4">}</a>
<a class="sourceLine" id="cb27-5" title="5"></a>
<a class="sourceLine" id="cb27-6" title="6">vec_cast.vctrs_decimal &lt;-<span class="st"> </span><span class="cf">function</span>(x, to, ...) <span class="kw">UseMethod</span>(<span class="st">&quot;vec_cast.vctrs_decimal&quot;</span>)</a>
<a class="sourceLine" id="cb27-7" title="7">vec_cast.vctrs_decimal.default &lt;-<span class="st"> </span><span class="cf">function</span>(x, to, ...) <span class="kw">vec_default_cast</span>(x, to)</a></code></pre></div>
<p>Casting and coercing from one decimal to another requires a little thought as the values of the <code>digits</code> attribute might be different, and we need some way to reconcile them. Here I’ve chosen to chose the maximum of the two; other reasonable options are to take the value from the left-hand side or throw an error.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb28-1" title="1">vec_ptype2.vctrs_decimal.vctrs_decimal &lt;-<span class="st"> </span><span class="cf">function</span>(x, y, ...) {</a>
<a class="sourceLine" id="cb28-2" title="2">  <span class="kw">new_decimal</span>(<span class="dt">digits =</span> <span class="kw">max</span>(<span class="kw">digits</span>(x), <span class="kw">digits</span>(y)))</a>
<a class="sourceLine" id="cb28-3" title="3">}</a>
<a class="sourceLine" id="cb28-4" title="4">vec_cast.vctrs_decimal.vctrs_decimal &lt;-<span class="st"> </span><span class="cf">function</span>(x, to, ...) {</a>
<a class="sourceLine" id="cb28-5" title="5">  <span class="kw">new_decimal</span>(<span class="kw">vec_data</span>(x), <span class="dt">digits =</span> <span class="kw">digits</span>(to))</a>
<a class="sourceLine" id="cb28-6" title="6">}</a>
<a class="sourceLine" id="cb28-7" title="7"></a>
<a class="sourceLine" id="cb28-8" title="8"><span class="kw">vec_c</span>(<span class="kw">decimal</span>(<span class="dv">1</span><span class="op">/</span><span class="dv">100</span>, <span class="dt">digits =</span> <span class="dv">3</span>), <span class="kw">decimal</span>(<span class="dv">2</span><span class="op">/</span><span class="dv">100</span>, <span class="dt">digits =</span> <span class="dv">2</span>))</a>
<a class="sourceLine" id="cb28-9" title="9"><span class="co">#&gt; &lt;decimal&lt;3&gt;[2]&gt;</span></a>
<a class="sourceLine" id="cb28-10" title="10"><span class="co">#&gt; [1] 0.010 0.020</span></a></code></pre></div>
<p>Finally, I can implement coercion to and from other types, like doubles. When automatically coercing, I choose the richer type (i.e. the decimal).</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb29-1" title="1">vec_ptype2.vctrs_decimal.double &lt;-<span class="st"> </span><span class="cf">function</span>(x, y, ...) x</a>
<a class="sourceLine" id="cb29-2" title="2">vec_ptype2.double.vctrs_decimal &lt;-<span class="st"> </span><span class="cf">function</span>(x, y, ...) y</a>
<a class="sourceLine" id="cb29-3" title="3"></a>
<a class="sourceLine" id="cb29-4" title="4">vec_cast.vctrs_decimal.double  &lt;-<span class="st"> </span><span class="cf">function</span>(x, to, ...) <span class="kw">new_decimal</span>(x, <span class="dt">digits =</span> <span class="kw">digits</span>(to))</a>
<a class="sourceLine" id="cb29-5" title="5">vec_cast.double.vctrs_decimal  &lt;-<span class="st"> </span><span class="cf">function</span>(x, to, ...) <span class="kw">vec_data</span>(x)</a>
<a class="sourceLine" id="cb29-6" title="6"></a>
<a class="sourceLine" id="cb29-7" title="7"><span class="kw">vec_c</span>(<span class="kw">decimal</span>(<span class="dv">1</span>, <span class="dt">digits =</span> <span class="dv">1</span>), pi)</a>
<a class="sourceLine" id="cb29-8" title="8"><span class="co">#&gt; &lt;decimal&lt;1&gt;[2]&gt;</span></a>
<a class="sourceLine" id="cb29-9" title="9"><span class="co">#&gt; [1] 1.0 3.1</span></a>
<a class="sourceLine" id="cb29-10" title="10"><span class="kw">vec_c</span>(pi, <span class="kw">decimal</span>(<span class="dv">1</span>, <span class="dt">digits =</span> <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb29-11" title="11"><span class="co">#&gt; &lt;decimal&lt;1&gt;[2]&gt;</span></a>
<a class="sourceLine" id="cb29-12" title="12"><span class="co">#&gt; [1] 3.1 1.0</span></a></code></pre></div>
<p>If type <code>x</code> has greater resolution than <code>y</code>, there will be some inputs that lose precision. These should generate errors using <code>stop_lossy_cast()</code>. You can see that in action when casting from doubles to integers; only some doubles can become integers without losing resolution.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb30-1" title="1"><span class="kw">vec_cast</span>(<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">10</span>), <span class="dt">to =</span> <span class="kw">integer</span>())</a>
<a class="sourceLine" id="cb30-2" title="2"><span class="co">#&gt; [1]  1  2 10</span></a>
<a class="sourceLine" id="cb30-3" title="3"></a>
<a class="sourceLine" id="cb30-4" title="4"><span class="kw">vec_cast</span>(<span class="kw">c</span>(<span class="fl">1.5</span>, <span class="dv">2</span>, <span class="fl">10.5</span>), <span class="dt">to =</span> <span class="kw">integer</span>())</a>
<a class="sourceLine" id="cb30-5" title="5"><span class="co">#&gt; Lossy cast from `x` &lt;double&gt; to `to` &lt;integer&gt;.</span></a>
<a class="sourceLine" id="cb30-6" title="6"><span class="co">#&gt; Locations: 1, 3</span></a></code></pre></div>
</div>
<div id="cached-sum" class="section level3">
<h3>Cached sum class</h3>
<p>The next level up in complexity is an object that has data-dependent attributes. To explore this idea we’ll create a vector that caches the sum of its values. As usual, we start with low-level and user-friendly constructors:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb31-1" title="1">new_cached_sum &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">x =</span> <span class="kw">double</span>(), <span class="dt">sum =</span> 0L) {</a>
<a class="sourceLine" id="cb31-2" title="2">  <span class="kw">vec_assert</span>(x, <span class="dt">ptype =</span> <span class="kw">double</span>())</a>
<a class="sourceLine" id="cb31-3" title="3">  <span class="kw">vec_assert</span>(sum, <span class="dt">ptype =</span> <span class="kw">double</span>(), <span class="dt">size =</span> 1L)</a>
<a class="sourceLine" id="cb31-4" title="4"></a>
<a class="sourceLine" id="cb31-5" title="5">  <span class="kw">new_vctr</span>(x, <span class="dt">sum =</span> sum, <span class="dt">class =</span> <span class="st">&quot;vctrs_cached_sum&quot;</span>)</a>
<a class="sourceLine" id="cb31-6" title="6">}</a>
<a class="sourceLine" id="cb31-7" title="7"></a>
<a class="sourceLine" id="cb31-8" title="8">cached_sum &lt;-<span class="st"> </span><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb31-9" title="9">  x &lt;-<span class="st"> </span><span class="kw">vec_cast</span>(x, <span class="kw">double</span>())</a>
<a class="sourceLine" id="cb31-10" title="10">  <span class="kw">new_cached_sum</span>(x, <span class="kw">sum</span>(x))</a>
<a class="sourceLine" id="cb31-11" title="11">}</a></code></pre></div>
<p>For this class, we can use the default <code>format()</code> method, and instead, we’ll customise the <code>obj_print_footer()</code> method. This is a good place to display user facing attributes.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb32-1" title="1">obj_print_footer.vctrs_cached_sum &lt;-<span class="st"> </span><span class="cf">function</span>(x, ...) {</a>
<a class="sourceLine" id="cb32-2" title="2">  <span class="kw">cat</span>(<span class="st">&quot;# Sum: &quot;</span>, <span class="kw">format</span>(<span class="kw">attr</span>(x, <span class="st">&quot;sum&quot;</span>), <span class="dt">digits =</span> <span class="dv">3</span>), <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>, <span class="dt">sep =</span> <span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb32-3" title="3">}</a>
<a class="sourceLine" id="cb32-4" title="4"></a>
<a class="sourceLine" id="cb32-5" title="5">x &lt;-<span class="st"> </span><span class="kw">cached_sum</span>(<span class="kw">runif</span>(<span class="dv">10</span>))</a>
<a class="sourceLine" id="cb32-6" title="6">x</a>
<a class="sourceLine" id="cb32-7" title="7"><span class="co">#&gt; &lt;vctrs_cached_sum[10]&gt;</span></a>
<a class="sourceLine" id="cb32-8" title="8"><span class="co">#&gt;  [1] 0.87460066 0.17494063 0.03424133 0.32038573 0.40232824 0.19566983</span></a>
<a class="sourceLine" id="cb32-9" title="9"><span class="co">#&gt;  [7] 0.40353812 0.06366146 0.38870131 0.97554784</span></a>
<a class="sourceLine" id="cb32-10" title="10"><span class="co">#&gt; # Sum: 3.83</span></a></code></pre></div>
<p>We’ll also override <code>sum()</code> and <code>mean()</code> to use the attribute. This is easiest to do with <code>vec_math()</code>, which you’ll learn about later.</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb33-1" title="1">vec_math.vctrs_cached_sum &lt;-<span class="st"> </span><span class="cf">function</span>(.fn, .x, ...) {</a>
<a class="sourceLine" id="cb33-2" title="2">  <span class="kw">cat</span>(<span class="st">&quot;Using cache</span><span class="ch">\n</span><span class="st">&quot;</span>)</a>
<a class="sourceLine" id="cb33-3" title="3">  <span class="cf">switch</span>(.fn,</a>
<a class="sourceLine" id="cb33-4" title="4">    <span class="dt">sum =</span> <span class="kw">attr</span>(.x, <span class="st">&quot;sum&quot;</span>),</a>
<a class="sourceLine" id="cb33-5" title="5">    <span class="dt">mean =</span> <span class="kw">attr</span>(.x, <span class="st">&quot;sum&quot;</span>) <span class="op">/</span><span class="st"> </span><span class="kw">length</span>(.x),</a>
<a class="sourceLine" id="cb33-6" title="6">    <span class="kw">vec_math_base</span>(.fn, .x, ...)</a>
<a class="sourceLine" id="cb33-7" title="7">  )</a>
<a class="sourceLine" id="cb33-8" title="8">}</a>
<a class="sourceLine" id="cb33-9" title="9"></a>
<a class="sourceLine" id="cb33-10" title="10"><span class="kw">sum</span>(x)</a>
<a class="sourceLine" id="cb33-11" title="11"><span class="co">#&gt; Using cache</span></a>
<a class="sourceLine" id="cb33-12" title="12"><span class="co">#&gt; [1] 3.833615</span></a></code></pre></div>
<p>As mentioned above, vctrs assumes that attributes are independent of the data. This means that when we take advantage of the default methods, they’ll work, but return the incorrect result:</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb34-1" title="1">x[<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>]</a>
<a class="sourceLine" id="cb34-2" title="2"><span class="co">#&gt; &lt;vctrs_cached_sum[2]&gt;</span></a>
<a class="sourceLine" id="cb34-3" title="3"><span class="co">#&gt; [1] 0.8746007 0.1749406</span></a>
<a class="sourceLine" id="cb34-4" title="4"><span class="co">#&gt; # Sum: 3.83</span></a></code></pre></div>
<p>To fix this, you need to provide a <code>vec_restore()</code> method. Note that this method dispatches on the <code>to</code> argument.</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb35-1" title="1">vec_restore.vctrs_cached_sum &lt;-<span class="st"> </span><span class="cf">function</span>(x, to, ..., <span class="dt">i =</span> <span class="ot">NULL</span>) {</a>
<a class="sourceLine" id="cb35-2" title="2">  <span class="kw">new_cached_sum</span>(x, <span class="kw">sum</span>(x))</a>
<a class="sourceLine" id="cb35-3" title="3">}</a>
<a class="sourceLine" id="cb35-4" title="4"></a>
<a class="sourceLine" id="cb35-5" title="5">x[<span class="dv">1</span>]</a>
<a class="sourceLine" id="cb35-6" title="6"><span class="co">#&gt; &lt;vctrs_cached_sum[1]&gt;</span></a>
<a class="sourceLine" id="cb35-7" title="7"><span class="co">#&gt; [1] 0.8746007</span></a>
<a class="sourceLine" id="cb35-8" title="8"><span class="co">#&gt; # Sum: 0.875</span></a></code></pre></div>
<p>This works because most of the vctrs methods dispatch to the underlying base function, by first stripping off extra attributes with <code>vec_data()</code> and then reapplying them again with <code>vec_restore()</code>. The default <code>vec_restore()</code> method copies over all attributes, which is not appropriate when the attributes depend on the data.</p>
<p>Note that <code>vec_restore.class</code> is subtly different from <code>vec_cast.class.class()</code>. <code>vec_restore()</code> is used when restoring attributes that have been lost; <code>vec_cast()</code> is used for coercions. This is easier to understand with a concrete example. Imagine factors were implemented with <code>new_vctr()</code>. <code>vec_restore.factor()</code> would restore attributes back to an integer vector, but you would not want to allow manually casting an integer to a factor with <code>vec_cast()</code>.</p>
</div>
</div>
<div id="record-style-objects" class="section level2">
<h2>Record-style objects</h2>
<p>Record-style objects use a list of equal-length vectors to represent individual components of the object. The best example of this is <code>POSIXlt</code>, which underneath the hood is a list of 11 fields like year, month, and day. Record-style classes override <code>length()</code> and subsetting methods to conceal this implementation detail.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb36-1" title="1">x &lt;-<span class="st"> </span><span class="kw">as.POSIXlt</span>(<span class="kw">ISOdatetime</span>(<span class="dv">2020</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>))</a>
<a class="sourceLine" id="cb36-2" title="2">x</a>
<a class="sourceLine" id="cb36-3" title="3"><span class="co">#&gt; [1] &quot;2020-01-01 00:00:01 CET&quot; &quot;2020-01-01 00:00:02 CET&quot;</span></a>
<a class="sourceLine" id="cb36-4" title="4"><span class="co">#&gt; [3] &quot;2020-01-01 00:00:03 CET&quot;</span></a>
<a class="sourceLine" id="cb36-5" title="5"></a>
<a class="sourceLine" id="cb36-6" title="6"><span class="kw">length</span>(x)</a>
<a class="sourceLine" id="cb36-7" title="7"><span class="co">#&gt; [1] 3</span></a>
<a class="sourceLine" id="cb36-8" title="8"><span class="kw">length</span>(<span class="kw">unclass</span>(x))</a>
<a class="sourceLine" id="cb36-9" title="9"><span class="co">#&gt; [1] 11</span></a>
<a class="sourceLine" id="cb36-10" title="10"></a>
<a class="sourceLine" id="cb36-11" title="11">x[[<span class="dv">1</span>]] <span class="co"># the first date time</span></a>
<a class="sourceLine" id="cb36-12" title="12"><span class="co">#&gt; [1] &quot;2020-01-01 00:00:01 CET&quot;</span></a>
<a class="sourceLine" id="cb36-13" title="13"><span class="kw">unclass</span>(x)[[<span class="dv">1</span>]] <span class="co"># the first component, the number of seconds</span></a>
<a class="sourceLine" id="cb36-14" title="14"><span class="co">#&gt; [1] 1 2 3</span></a></code></pre></div>
<p>vctrs makes it easy to create new record-style classes using <code>new_rcrd()</code>, which has a wide selection of default methods.</p>
<div id="rational-class" class="section level3">
<h3>Rational class</h3>
<p>A fraction, or rational number can be represented by a pair of integer vectors representing the numerator (the number on top) and the denominator (the number on bottom), where the length of each vector must be the same. To represent such a data structure we turn to a new base data type: the record (or rcrd for short).</p>
<p>As usual we start with low-level and user-friendly constructors. The low-level constructor calls <code>new_rcrd()</code> which needs a named list of equal-length vectors.</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb37-1" title="1">new_rational &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">n =</span> <span class="kw">integer</span>(), <span class="dt">d =</span> <span class="kw">integer</span>()) {</a>
<a class="sourceLine" id="cb37-2" title="2">  <span class="kw">vec_assert</span>(n, <span class="dt">ptype =</span> <span class="kw">integer</span>())</a>
<a class="sourceLine" id="cb37-3" title="3">  <span class="kw">vec_assert</span>(d, <span class="dt">ptype =</span> <span class="kw">integer</span>())</a>
<a class="sourceLine" id="cb37-4" title="4">  </a>
<a class="sourceLine" id="cb37-5" title="5">  <span class="kw">new_rcrd</span>(<span class="kw">list</span>(<span class="dt">n =</span> n, <span class="dt">d =</span> d), <span class="dt">class =</span> <span class="st">&quot;vctrs_rational&quot;</span>)</a>
<a class="sourceLine" id="cb37-6" title="6">}</a></code></pre></div>
<p>Our user friendly constructor casts <code>n</code> and <code>d</code> to integers and recycles them to the same length.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb38-1" title="1">rational &lt;-<span class="st"> </span><span class="cf">function</span>(n, d) {</a>
<a class="sourceLine" id="cb38-2" title="2">  <span class="kw">c</span>(n, d) <span class="op">%&lt;-%</span><span class="st"> </span><span class="kw">vec_cast_common</span>(n, d, <span class="dt">.to =</span> <span class="kw">integer</span>())</a>
<a class="sourceLine" id="cb38-3" title="3">  <span class="kw">c</span>(n, d) <span class="op">%&lt;-%</span><span class="st"> </span><span class="kw">vec_recycle_common</span>(n, d)</a>
<a class="sourceLine" id="cb38-4" title="4">  </a>
<a class="sourceLine" id="cb38-5" title="5">  <span class="kw">new_rational</span>(n, d)</a>
<a class="sourceLine" id="cb38-6" title="6">}</a>
<a class="sourceLine" id="cb38-7" title="7"></a>
<a class="sourceLine" id="cb38-8" title="8">x &lt;-<span class="st"> </span><span class="kw">rational</span>(<span class="dv">1</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">10</span>)</a></code></pre></div>
<p>Behind the scenes, <code>x</code> is a named list with two elements. But those details are hidden so that it behaves like a vector:</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb39-1" title="1"><span class="kw">names</span>(x)</a>
<a class="sourceLine" id="cb39-2" title="2"><span class="co">#&gt; NULL</span></a>
<a class="sourceLine" id="cb39-3" title="3"><span class="kw">length</span>(x)</a>
<a class="sourceLine" id="cb39-4" title="4"><span class="co">#&gt; [1] 10</span></a></code></pre></div>
<p>To access the underlying fields we need to use <code>field()</code> and <code>fields()</code>:</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb40-1" title="1"><span class="kw">fields</span>(x)</a>
<a class="sourceLine" id="cb40-2" title="2"><span class="co">#&gt; [1] &quot;n&quot; &quot;d&quot;</span></a>
<a class="sourceLine" id="cb40-3" title="3"><span class="kw">field</span>(x, <span class="st">&quot;n&quot;</span>)</a>
<a class="sourceLine" id="cb40-4" title="4"><span class="co">#&gt;  [1] 1 1 1 1 1 1 1 1 1 1</span></a></code></pre></div>
<p>This allows us to create a format method:</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb41-1" title="1">format.vctrs_rational &lt;-<span class="st"> </span><span class="cf">function</span>(x, ...) {</a>
<a class="sourceLine" id="cb41-2" title="2">  n &lt;-<span class="st"> </span><span class="kw">field</span>(x, <span class="st">&quot;n&quot;</span>)</a>
<a class="sourceLine" id="cb41-3" title="3">  d &lt;-<span class="st"> </span><span class="kw">field</span>(x, <span class="st">&quot;d&quot;</span>)</a>
<a class="sourceLine" id="cb41-4" title="4">  </a>
<a class="sourceLine" id="cb41-5" title="5">  out &lt;-<span class="st"> </span><span class="kw">paste0</span>(n, <span class="st">&quot;/&quot;</span>, d)</a>
<a class="sourceLine" id="cb41-6" title="6">  out[<span class="kw">is.na</span>(n) <span class="op">|</span><span class="st"> </span><span class="kw">is.na</span>(d)] &lt;-<span class="st"> </span><span class="ot">NA</span></a>
<a class="sourceLine" id="cb41-7" title="7">  </a>
<a class="sourceLine" id="cb41-8" title="8">  out</a>
<a class="sourceLine" id="cb41-9" title="9">}</a>
<a class="sourceLine" id="cb41-10" title="10"></a>
<a class="sourceLine" id="cb41-11" title="11">vec_ptype_abbr.vctrs_rational &lt;-<span class="st"> </span><span class="cf">function</span>(x, ...) <span class="st">&quot;rtnl&quot;</span></a>
<a class="sourceLine" id="cb41-12" title="12">vec_ptype_full.vctrs_rational &lt;-<span class="st"> </span><span class="cf">function</span>(x, ...) <span class="st">&quot;rational&quot;</span></a>
<a class="sourceLine" id="cb41-13" title="13"></a>
<a class="sourceLine" id="cb41-14" title="14">x</a>
<a class="sourceLine" id="cb41-15" title="15"><span class="co">#&gt; &lt;rational[10]&gt;</span></a>
<a class="sourceLine" id="cb41-16" title="16"><span class="co">#&gt;  [1] 1/1  1/2  1/3  1/4  1/5  1/6  1/7  1/8  1/9  1/10</span></a></code></pre></div>
<p>vctrs uses the <code>format()</code> method in <code>str()</code>, hiding the underlying implementation details from the user:</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb42-1" title="1"><span class="kw">str</span>(x)</a>
<a class="sourceLine" id="cb42-2" title="2"><span class="co">#&gt;  rtnl [1:10] 1/1, 1/2, 1/3, 1/4, 1/5, 1/6, 1/7, 1/8, 1/9, 1/10</span></a></code></pre></div>
<p>For <code>rational</code>, <code>vec_ptype2()</code> and <code>vec_cast()</code> follow the same pattern as <code>percent()</code>. I allow coercion from integer and to doubles.</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb43-1" title="1">vec_ptype2.vctrs_rational &lt;-<span class="st"> </span><span class="cf">function</span>(x, y, ...) <span class="kw">UseMethod</span>(<span class="st">&quot;vec_ptype2.vctrs_rational&quot;</span>, y)</a>
<a class="sourceLine" id="cb43-2" title="2">vec_ptype2.vctrs_rational.default &lt;-<span class="st"> </span><span class="cf">function</span>(x, y, ..., <span class="dt">x_arg =</span> <span class="st">&quot;x&quot;</span>, <span class="dt">y_arg =</span> <span class="st">&quot;y&quot;</span>) {</a>
<a class="sourceLine" id="cb43-3" title="3">  <span class="kw">vec_default_ptype2</span>(x, y, <span class="dt">x_arg =</span> x_arg, <span class="dt">y_arg =</span> y_arg)</a>
<a class="sourceLine" id="cb43-4" title="4">}</a>
<a class="sourceLine" id="cb43-5" title="5">vec_ptype2.vctrs_rational.vctrs_rational &lt;-<span class="st"> </span><span class="cf">function</span>(x, y, ...) <span class="kw">new_rational</span>()</a>
<a class="sourceLine" id="cb43-6" title="6">vec_ptype2.vctrs_rational.integer &lt;-<span class="st"> </span><span class="cf">function</span>(x, y, ...) <span class="kw">new_rational</span>()</a>
<a class="sourceLine" id="cb43-7" title="7">vec_ptype2.integer.vctrs_rational &lt;-<span class="st"> </span><span class="cf">function</span>(x, y, ...) <span class="kw">new_rational</span>()</a>
<a class="sourceLine" id="cb43-8" title="8"></a>
<a class="sourceLine" id="cb43-9" title="9">vec_cast.vctrs_rational &lt;-<span class="st"> </span><span class="cf">function</span>(x, to, ...) <span class="kw">UseMethod</span>(<span class="st">&quot;vec_cast.vctrs_rational&quot;</span>)</a>
<a class="sourceLine" id="cb43-10" title="10">vec_cast.vctrs_rational.default &lt;-<span class="st"> </span><span class="cf">function</span>(x, to, ...) <span class="kw">vec_default_cast</span>(x, to)</a>
<a class="sourceLine" id="cb43-11" title="11">vec_cast.vctrs_rational.vctrs_rational &lt;-<span class="st"> </span><span class="cf">function</span>(x, to, ...) x</a>
<a class="sourceLine" id="cb43-12" title="12">vec_cast.double.vctrs_rational &lt;-<span class="st"> </span><span class="cf">function</span>(x, to, ...) <span class="kw">field</span>(x, <span class="st">&quot;n&quot;</span>) <span class="op">/</span><span class="st"> </span><span class="kw">field</span>(x, <span class="st">&quot;d&quot;</span>)</a>
<a class="sourceLine" id="cb43-13" title="13">vec_cast.vctrs_rational.integer &lt;-<span class="st"> </span><span class="cf">function</span>(x, to, ...) <span class="kw">rational</span>(x, <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb43-14" title="14"></a>
<a class="sourceLine" id="cb43-15" title="15"><span class="kw">vec_c</span>(<span class="kw">rational</span>(<span class="dv">1</span>, <span class="dv">2</span>), 1L, <span class="ot">NA</span>)</a>
<a class="sourceLine" id="cb43-16" title="16"><span class="co">#&gt; &lt;rational[3]&gt;</span></a>
<a class="sourceLine" id="cb43-17" title="17"><span class="co">#&gt; [1] 1/2  1/1  &lt;NA&gt;</span></a></code></pre></div>
</div>
<div id="decimal2-class" class="section level3">
<h3>Decimal2 class</h3>
<p>The previous implementation of <code>decimal</code> was built on top of doubles. This is a bad idea because decimal vectors are typically used when you care about precise values (i.e. dollars and cents in a bank account), and double values suffer from floating point problems.</p>
<p>A better implementation of a decimal class would be to use pair of integers, one for the value to the left of the decimal point, and the other for the value to the right (divided by a <code>scale</code>). The code is a very quick sketch of how you might start creating such a class:</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb44-1" title="1">new_decimal2 &lt;-<span class="st"> </span><span class="cf">function</span>(l, r, <span class="dt">scale =</span> 2L) {</a>
<a class="sourceLine" id="cb44-2" title="2">  <span class="kw">vec_assert</span>(l, <span class="dt">ptype =</span> <span class="kw">integer</span>())</a>
<a class="sourceLine" id="cb44-3" title="3">  <span class="kw">vec_assert</span>(r, <span class="dt">ptype =</span> <span class="kw">integer</span>())</a>
<a class="sourceLine" id="cb44-4" title="4">  <span class="kw">vec_assert</span>(scale, <span class="dt">ptype =</span> <span class="kw">integer</span>(), <span class="dt">size =</span> 1L)</a>
<a class="sourceLine" id="cb44-5" title="5">  </a>
<a class="sourceLine" id="cb44-6" title="6">  <span class="kw">new_rcrd</span>(<span class="kw">list</span>(<span class="dt">l =</span> l, <span class="dt">r =</span> r), <span class="dt">scale =</span> scale, <span class="dt">class =</span> <span class="st">&quot;vctrs_decimal2&quot;</span>)</a>
<a class="sourceLine" id="cb44-7" title="7">}</a>
<a class="sourceLine" id="cb44-8" title="8"></a>
<a class="sourceLine" id="cb44-9" title="9">decimal2 &lt;-<span class="st"> </span><span class="cf">function</span>(l, r, <span class="dt">scale =</span> 2L) {</a>
<a class="sourceLine" id="cb44-10" title="10">  l &lt;-<span class="st"> </span><span class="kw">vec_cast</span>(l, <span class="kw">integer</span>())</a>
<a class="sourceLine" id="cb44-11" title="11">  r &lt;-<span class="st"> </span><span class="kw">vec_cast</span>(r, <span class="kw">integer</span>())</a>
<a class="sourceLine" id="cb44-12" title="12">  <span class="kw">c</span>(l, r) <span class="op">%&lt;-%</span><span class="st"> </span><span class="kw">vec_recycle_common</span>(l, r)</a>
<a class="sourceLine" id="cb44-13" title="13">  scale &lt;-<span class="st"> </span><span class="kw">vec_cast</span>(scale, <span class="kw">integer</span>())</a>
<a class="sourceLine" id="cb44-14" title="14">  </a>
<a class="sourceLine" id="cb44-15" title="15">  <span class="co"># should check that r &lt; 10^scale</span></a>
<a class="sourceLine" id="cb44-16" title="16">  <span class="kw">new_decimal2</span>(<span class="dt">l =</span> l, <span class="dt">r =</span> r, <span class="dt">scale =</span> scale)</a>
<a class="sourceLine" id="cb44-17" title="17">}</a>
<a class="sourceLine" id="cb44-18" title="18"></a>
<a class="sourceLine" id="cb44-19" title="19">format.vctrs_decimal2 &lt;-<span class="st"> </span><span class="cf">function</span>(x, ...) {</a>
<a class="sourceLine" id="cb44-20" title="20">  val &lt;-<span class="st"> </span><span class="kw">field</span>(x, <span class="st">&quot;l&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">field</span>(x, <span class="st">&quot;r&quot;</span>) <span class="op">/</span><span class="st"> </span><span class="dv">10</span><span class="op">^</span><span class="kw">attr</span>(x, <span class="st">&quot;scale&quot;</span>)</a>
<a class="sourceLine" id="cb44-21" title="21">  <span class="kw">sprintf</span>(<span class="kw">paste0</span>(<span class="st">&quot;%.0&quot;</span>, <span class="kw">attr</span>(x, <span class="st">&quot;scale&quot;</span>), <span class="st">&quot;f&quot;</span>), val)</a>
<a class="sourceLine" id="cb44-22" title="22">}</a>
<a class="sourceLine" id="cb44-23" title="23"></a>
<a class="sourceLine" id="cb44-24" title="24"><span class="kw">decimal2</span>(<span class="dv">10</span>, <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">5</span>, <span class="dv">99</span>))</a>
<a class="sourceLine" id="cb44-25" title="25"><span class="co">#&gt; &lt;vctrs_decimal2[3]&gt;</span></a>
<a class="sourceLine" id="cb44-26" title="26"><span class="co">#&gt; [1] 10.00 10.05 10.99</span></a></code></pre></div>
</div>
</div>
<div id="equality-and-comparison" class="section level2">
<h2>Equality and comparison</h2>
<p>vctrs provides three “proxy” generics. Two of those let you control how your class determines equality and ordering:</p>
<ul>
<li><p><code>vec_proxy_equal()</code> returns a data vector suitable for comparison. It underpins <code>==</code>, <code>!=</code>, <code>unique()</code>, <code>anyDuplicated()</code>, and <code>is.na()</code>. By default, it just calls <code>vec_proxy()</code>.</p></li>
<li><p><code>vec_proxy_compare()</code> specifies how to compare the elements of your vector. This proxy is used in <code>&lt;</code>, <code>&lt;=</code>, <code>&gt;=</code>, <code>&gt;</code>, <code>min()</code>, <code>max()</code>, <code>median()</code>, <code>quantile()</code>, and <code>xtfrm()</code> (used in <code>order()</code> and <code>sort()</code>) methods.</p></li>
</ul>
<p>By default, <code>vec_proxy_equal()</code> and <code>vec_proxy_compare()</code> just call <code>vec_proxy()</code>.</p>
<ul>
<li><code>vec_proxy()</code> returns the actual data of a vector. This is useful when you store the data in a field of your class. Most of the time, you shouldn’t need to implement <code>vec_proxy()</code>.</li>
</ul>
<p>You should only implement these proxies when some preprocessing on the data is needed to make elements comparable. In that case, defining these methods will get you a lot of behaviour for relatively little work.</p>
<p>These proxy functions should always return a simple object (either a bare vector or a data frame), that possesses the same properties as your class. This permits efficient implementation of the vctrs internals because it allows dispatch to happen once in R, and then efficient computations can be written in C.</p>
<div id="rational-class-1" class="section level3">
<h3>Rational class</h3>
<p>Let’s explore these ideas by with the rational class we started on above. By default, <code>vec_proxy()</code> converts a record to a data frame, and the default comparison works column by column:</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb45-1" title="1">x &lt;-<span class="st"> </span><span class="kw">rational</span>(<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">2</span>), <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>))</a>
<a class="sourceLine" id="cb45-2" title="2">x</a>
<a class="sourceLine" id="cb45-3" title="3"><span class="co">#&gt; &lt;rational[4]&gt;</span></a>
<a class="sourceLine" id="cb45-4" title="4"><span class="co">#&gt; [1] 1/1 2/1 1/2 2/2</span></a>
<a class="sourceLine" id="cb45-5" title="5"></a>
<a class="sourceLine" id="cb45-6" title="6"><span class="kw">vec_proxy</span>(x)</a>
<a class="sourceLine" id="cb45-7" title="7"><span class="co">#&gt;   n d</span></a>
<a class="sourceLine" id="cb45-8" title="8"><span class="co">#&gt; 1 1 1</span></a>
<a class="sourceLine" id="cb45-9" title="9"><span class="co">#&gt; 2 2 1</span></a>
<a class="sourceLine" id="cb45-10" title="10"><span class="co">#&gt; 3 1 2</span></a>
<a class="sourceLine" id="cb45-11" title="11"><span class="co">#&gt; 4 2 2</span></a>
<a class="sourceLine" id="cb45-12" title="12"></a>
<a class="sourceLine" id="cb45-13" title="13">x <span class="op">==</span><span class="st"> </span><span class="kw">rational</span>(<span class="dv">1</span>, <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb45-14" title="14"><span class="co">#&gt; [1]  TRUE FALSE FALSE FALSE</span></a></code></pre></div>
<p>This makes sense as a default, but isn’t correct here because <code>rational(1, 1)</code> represents the same number as <code>rational(2, 2)</code> so they should be equal. We can fix that by implementing a <code>vec_proxy_equal()</code> method that by divides <code>n</code> and <code>d</code> by their greatest common divisor:</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb46-1" title="1"><span class="co"># Thanks to Matthew Lundberg: https://stackoverflow.com/a/21504113/16632 </span></a>
<a class="sourceLine" id="cb46-2" title="2">gcd &lt;-<span class="st"> </span><span class="cf">function</span>(x, y) {</a>
<a class="sourceLine" id="cb46-3" title="3">  r &lt;-<span class="st"> </span>x <span class="op">%%</span><span class="st"> </span>y</a>
<a class="sourceLine" id="cb46-4" title="4">  <span class="kw">ifelse</span>(r, <span class="kw">gcd</span>(y, r), y)</a>
<a class="sourceLine" id="cb46-5" title="5">}</a>
<a class="sourceLine" id="cb46-6" title="6"></a>
<a class="sourceLine" id="cb46-7" title="7">vec_proxy_equal.vctrs_rational &lt;-<span class="st"> </span><span class="cf">function</span>(x, ...) {</a>
<a class="sourceLine" id="cb46-8" title="8">  n &lt;-<span class="st"> </span><span class="kw">field</span>(x, <span class="st">&quot;n&quot;</span>)</a>
<a class="sourceLine" id="cb46-9" title="9">  d &lt;-<span class="st"> </span><span class="kw">field</span>(x, <span class="st">&quot;d&quot;</span>)</a>
<a class="sourceLine" id="cb46-10" title="10">  gcd &lt;-<span class="st"> </span><span class="kw">gcd</span>(n, d)</a>
<a class="sourceLine" id="cb46-11" title="11">  </a>
<a class="sourceLine" id="cb46-12" title="12">  <span class="kw">data.frame</span>(<span class="dt">n =</span> n <span class="op">/</span><span class="st"> </span>gcd, <span class="dt">d =</span> d <span class="op">/</span><span class="st"> </span>gcd)</a>
<a class="sourceLine" id="cb46-13" title="13">}</a>
<a class="sourceLine" id="cb46-14" title="14"><span class="kw">vec_proxy</span>(x)</a>
<a class="sourceLine" id="cb46-15" title="15"><span class="co">#&gt;   n d</span></a>
<a class="sourceLine" id="cb46-16" title="16"><span class="co">#&gt; 1 1 1</span></a>
<a class="sourceLine" id="cb46-17" title="17"><span class="co">#&gt; 2 2 1</span></a>
<a class="sourceLine" id="cb46-18" title="18"><span class="co">#&gt; 3 1 2</span></a>
<a class="sourceLine" id="cb46-19" title="19"><span class="co">#&gt; 4 2 2</span></a>
<a class="sourceLine" id="cb46-20" title="20"></a>
<a class="sourceLine" id="cb46-21" title="21">x <span class="op">==</span><span class="st"> </span><span class="kw">rational</span>(<span class="dv">1</span>, <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb46-22" title="22"><span class="co">#&gt; [1]  TRUE FALSE FALSE  TRUE</span></a></code></pre></div>
<p><code>vec_proxy_equal()</code> is also used by <code>unique()</code>:</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb47-1" title="1"><span class="kw">unique</span>(x)</a>
<a class="sourceLine" id="cb47-2" title="2"><span class="co">#&gt; &lt;rational[3]&gt;</span></a>
<a class="sourceLine" id="cb47-3" title="3"><span class="co">#&gt; [1] 1/1 2/1 1/2</span></a></code></pre></div>
<p>We now need to fix <code>sort()</code> similarly, since it currently sorts by <code>n</code>, then by <code>d</code>:</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb48-1" title="1"><span class="kw">sort</span>(x)</a>
<a class="sourceLine" id="cb48-2" title="2"><span class="co">#&gt; &lt;rational[4]&gt;</span></a>
<a class="sourceLine" id="cb48-3" title="3"><span class="co">#&gt; [1] 1/1 1/2 2/1 2/2</span></a></code></pre></div>
<p>The easiest fix is to convert the fraction to a decimal and then sort that:</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb49-1" title="1">vec_proxy_compare.vctrs_rational &lt;-<span class="st"> </span><span class="cf">function</span>(x, ...) {</a>
<a class="sourceLine" id="cb49-2" title="2">  <span class="kw">field</span>(x, <span class="st">&quot;n&quot;</span>) <span class="op">/</span><span class="st"> </span><span class="kw">field</span>(x, <span class="st">&quot;d&quot;</span>)</a>
<a class="sourceLine" id="cb49-3" title="3">}</a>
<a class="sourceLine" id="cb49-4" title="4"></a>
<a class="sourceLine" id="cb49-5" title="5"><span class="kw">sort</span>(x)</a>
<a class="sourceLine" id="cb49-6" title="6"><span class="co">#&gt; &lt;rational[4]&gt;</span></a>
<a class="sourceLine" id="cb49-7" title="7"><span class="co">#&gt; [1] 1/2 1/1 2/2 2/1</span></a></code></pre></div>
<p>(We could have used the same approach in <code>vec_proxy_equal()</code>, but when working with floating point numbers it’s not necessarily true that <code>x == y</code> implies that <code>d * x == d * y</code>.)</p>
</div>
<div id="polynomial-class" class="section level3">
<h3>Polynomial class</h3>
<p>A related problem occurs if we build our vector on top of a list. The following code defines a polynomial class that represents polynomials (like <code>1 + 3x - 2x^2</code>) using a list of integer vectors (like <code>c(1, 3, -2)</code>). Note the use of <code>new_list_of()</code> in the constructor.</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb50-1" title="1">new_poly &lt;-<span class="st"> </span><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb50-2" title="2">  <span class="kw">new_list_of</span>(x, <span class="dt">ptype =</span> <span class="kw">integer</span>(), <span class="dt">class =</span> <span class="st">&quot;vctrs_poly&quot;</span>)</a>
<a class="sourceLine" id="cb50-3" title="3">}</a>
<a class="sourceLine" id="cb50-4" title="4"></a>
<a class="sourceLine" id="cb50-5" title="5">poly &lt;-<span class="st"> </span><span class="cf">function</span>(...) {</a>
<a class="sourceLine" id="cb50-6" title="6">  x &lt;-<span class="st"> </span><span class="kw">list</span>(...)</a>
<a class="sourceLine" id="cb50-7" title="7">  x &lt;-<span class="st"> </span><span class="kw">lapply</span>(x, vec_cast, <span class="kw">integer</span>())</a>
<a class="sourceLine" id="cb50-8" title="8">  <span class="kw">new_poly</span>(x)</a>
<a class="sourceLine" id="cb50-9" title="9">}</a>
<a class="sourceLine" id="cb50-10" title="10"></a>
<a class="sourceLine" id="cb50-11" title="11">vec_ptype_full.vctrs_poly &lt;-<span class="st"> </span><span class="cf">function</span>(x, ...) <span class="st">&quot;polynomial&quot;</span></a>
<a class="sourceLine" id="cb50-12" title="12">vec_ptype_abbr.vctrs_poly &lt;-<span class="st"> </span><span class="cf">function</span>(x, ...) <span class="st">&quot;poly&quot;</span></a>
<a class="sourceLine" id="cb50-13" title="13"></a>
<a class="sourceLine" id="cb50-14" title="14">format.vctrs_poly &lt;-<span class="st"> </span><span class="cf">function</span>(x, ...) {</a>
<a class="sourceLine" id="cb50-15" title="15">  format_one &lt;-<span class="st"> </span><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb50-16" title="16">    <span class="cf">if</span> (<span class="kw">length</span>(x) <span class="op">==</span><span class="st"> </span><span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb50-17" title="17">      <span class="kw">return</span>(<span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb50-18" title="18">    } <span class="cf">else</span> <span class="cf">if</span> (<span class="kw">length</span>(x) <span class="op">==</span><span class="st"> </span><span class="dv">1</span>) {</a>
<a class="sourceLine" id="cb50-19" title="19">      <span class="kw">format</span>(x)</a>
<a class="sourceLine" id="cb50-20" title="20">    } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb50-21" title="21">      suffix &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">paste0</span>(<span class="st">&quot;\u22C5x^&quot;</span>, <span class="kw">seq</span>(<span class="kw">length</span>(x) <span class="op">-</span><span class="st"> </span><span class="dv">1</span>, <span class="dv">1</span>)), <span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb50-22" title="22">      out &lt;-<span class="st"> </span><span class="kw">paste0</span>(x, suffix)</a>
<a class="sourceLine" id="cb50-23" title="23">      out &lt;-<span class="st"> </span>out[x <span class="op">!=</span><span class="st"> </span>0L]</a>
<a class="sourceLine" id="cb50-24" title="24">      <span class="kw">paste0</span>(out, <span class="dt">collapse =</span> <span class="st">&quot; + &quot;</span>)</a>
<a class="sourceLine" id="cb50-25" title="25">    }</a>
<a class="sourceLine" id="cb50-26" title="26">  }</a>
<a class="sourceLine" id="cb50-27" title="27">  <span class="kw">vapply</span>(x, format_one, <span class="kw">character</span>(<span class="dv">1</span>))</a>
<a class="sourceLine" id="cb50-28" title="28">}</a>
<a class="sourceLine" id="cb50-29" title="29"></a>
<a class="sourceLine" id="cb50-30" title="30">obj_print_data.vctrs_poly &lt;-<span class="st"> </span><span class="cf">function</span>(x, ...) {</a>
<a class="sourceLine" id="cb50-31" title="31">  <span class="cf">if</span> (<span class="kw">length</span>(x) <span class="op">==</span><span class="st"> </span><span class="dv">0</span>)</a>
<a class="sourceLine" id="cb50-32" title="32">    <span class="kw">return</span>()</a>
<a class="sourceLine" id="cb50-33" title="33">  <span class="kw">print</span>(<span class="kw">format</span>(x), <span class="dt">quote =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb50-34" title="34">}</a>
<a class="sourceLine" id="cb50-35" title="35"></a>
<a class="sourceLine" id="cb50-36" title="36">p &lt;-<span class="st"> </span><span class="kw">poly</span>(<span class="dv">1</span>, <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>), <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">2</span>))</a>
<a class="sourceLine" id="cb50-37" title="37">p</a>
<a class="sourceLine" id="cb50-38" title="38"><span class="co">#&gt; &lt;polynomial[3]&gt;</span></a>
<a class="sourceLine" id="cb50-39" title="39"><span class="co">#&gt; [1] 1         1⋅x^2 + 1 1⋅x^4 + 2</span></a></code></pre></div>
<p>The resulting objects will inherit from the <code>vctrs_list_of</code> class, which provides tailored methods for <code>$</code>, <code>[[</code>, the corresponding assignment operators, and other methods.</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb51-1" title="1"><span class="kw">class</span>(p)</a>
<a class="sourceLine" id="cb51-2" title="2"><span class="co">#&gt; [1] &quot;vctrs_poly&quot;    &quot;vctrs_list_of&quot; &quot;vctrs_vctr&quot;</span></a>
<a class="sourceLine" id="cb51-3" title="3">p[<span class="dv">2</span>]</a>
<a class="sourceLine" id="cb51-4" title="4"><span class="co">#&gt; &lt;polynomial[1]&gt;</span></a>
<a class="sourceLine" id="cb51-5" title="5"><span class="co">#&gt; [1] 1⋅x^2 + 1</span></a>
<a class="sourceLine" id="cb51-6" title="6">p[[<span class="dv">2</span>]]</a>
<a class="sourceLine" id="cb51-7" title="7"><span class="co">#&gt; [1] 1 0 1</span></a></code></pre></div>
<p>Equality works out of the box because we can tell if two integer vectors are equal:</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb52-1" title="1">p <span class="op">==</span><span class="st"> </span><span class="kw">poly</span>(<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb52-2" title="2"><span class="co">#&gt; [1] FALSE  TRUE FALSE</span></a></code></pre></div>
<p>But we can’t order them, because lists are not comparable:</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb53-1" title="1"><span class="kw">sort</span>(p)</a>
<a class="sourceLine" id="cb53-2" title="2"><span class="co">#&gt; Invalid type returned by `vec_proxy_compare()`.</span></a></code></pre></div>
<p>So we need to define a <code>vec_proxy_compare()</code> method:</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb54-1" title="1">vec_proxy_compare.vctrs_poly &lt;-<span class="st"> </span><span class="cf">function</span>(x, ...) {</a>
<a class="sourceLine" id="cb54-2" title="2">  x_raw &lt;-<span class="st"> </span><span class="kw">vec_data</span>(x)</a>
<a class="sourceLine" id="cb54-3" title="3">  <span class="co"># First figure out the maximum length</span></a>
<a class="sourceLine" id="cb54-4" title="4">  n &lt;-<span class="st"> </span><span class="kw">max</span>(<span class="kw">vapply</span>(x_raw, length, <span class="kw">integer</span>(<span class="dv">1</span>)))</a>
<a class="sourceLine" id="cb54-5" title="5">  </a>
<a class="sourceLine" id="cb54-6" title="6">  <span class="co"># Then expand all vectors to this length by filling in with zeros</span></a>
<a class="sourceLine" id="cb54-7" title="7">  full &lt;-<span class="st"> </span><span class="kw">lapply</span>(x_raw, <span class="cf">function</span>(x) <span class="kw">c</span>(<span class="kw">rep</span>(0L, n <span class="op">-</span><span class="st"> </span><span class="kw">length</span>(x)), x))</a>
<a class="sourceLine" id="cb54-8" title="8">  </a>
<a class="sourceLine" id="cb54-9" title="9">  <span class="co"># Then turn into a data frame</span></a>
<a class="sourceLine" id="cb54-10" title="10">  <span class="kw">as.data.frame</span>(<span class="kw">do.call</span>(rbind, full))</a>
<a class="sourceLine" id="cb54-11" title="11">}</a>
<a class="sourceLine" id="cb54-12" title="12"></a>
<a class="sourceLine" id="cb54-13" title="13"><span class="kw">sort</span>(<span class="kw">poly</span>(<span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb54-14" title="14"><span class="co">#&gt; &lt;polynomial[3]&gt;</span></a>
<a class="sourceLine" id="cb54-15" title="15"><span class="co">#&gt; [1] 1 2 3</span></a>
<a class="sourceLine" id="cb54-16" title="16"><span class="kw">sort</span>(<span class="kw">poly</span>(<span class="dv">1</span>, <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>), <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">0</span>)))</a>
<a class="sourceLine" id="cb54-17" title="17"><span class="co">#&gt; &lt;polynomial[3]&gt;</span></a>
<a class="sourceLine" id="cb54-18" title="18"><span class="co">#&gt; [1] 1     1⋅x^1 1⋅x^2</span></a></code></pre></div>
</div>
</div>
<div id="arithmetic" class="section level2">
<h2>Arithmetic</h2>
<p>vctrs also provides two mathematical generics that allow you to define a broad swath of mathematical behaviour at once:</p>
<ul>
<li><p><code>vec_math(fn, x, ...)</code> specifies the behaviour of mathematical functions like <code>abs()</code>, <code>sum()</code>, and <code>mean()</code>. (See <code>?vec_math()</code> for the complete list.)</p></li>
<li><p><code>vec_arith(op, x, y)</code> specifies the behaviour of the arithmetic operations like <code>+</code>, <code>-</code>, and <code>%%</code>. (See <code>?vec_arith()</code> for the complete list.)</p></li>
</ul>
<p>Both generics define the behaviour for multiple functions because <code>sum.vctrs_vctr(x)</code> calls <code>vec_math.vctrs_vctr(&quot;sum&quot;, x)</code>, and <code>x + y</code> calls <code>vec_math.x_class.y_class(&quot;+&quot;, x, y)</code>. They’re accompanied by <code>vec_math_base()</code> and <code>vec_arith_base()</code> which make it easy to call the underlying base R functions.</p>
<p><code>vec_arith()</code> uses double dispatch, and needs the following standard boilerplate:</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb55-1" title="1">vec_arith.MYCLASS &lt;-<span class="st"> </span><span class="cf">function</span>(op, x, y, ...) {</a>
<a class="sourceLine" id="cb55-2" title="2">  <span class="kw">UseMethod</span>(<span class="st">&quot;vec_arith.MYCLASS&quot;</span>, y)</a>
<a class="sourceLine" id="cb55-3" title="3">}</a>
<a class="sourceLine" id="cb55-4" title="4">vec_arith.MYCLASS.default &lt;-<span class="st"> </span><span class="cf">function</span>(op, x, y, ...) {</a>
<a class="sourceLine" id="cb55-5" title="5">  <span class="kw">stop_incompatible_op</span>(op, x, y)</a>
<a class="sourceLine" id="cb55-6" title="6">}</a></code></pre></div>
<div id="cached-sum-class" class="section level3">
<h3>Cached sum class</h3>
<p>I showed an example of <code>vec_math()</code> to define <code>sum()</code> and <code>mean()</code> methods <code>cached_sum</code>. Now let’s talk about exactly how it works. Most <code>vec_math()</code> functions will have a similar form. You use a switch statement to handle the methods that you care about, and fall back to <code>vec_math_base()</code> for those that you don’t care about.</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb56-1" title="1">vec_math.vctrs_cached_sum &lt;-<span class="st"> </span><span class="cf">function</span>(.fn, .x, ...) {</a>
<a class="sourceLine" id="cb56-2" title="2">  <span class="cf">switch</span>(.fn,</a>
<a class="sourceLine" id="cb56-3" title="3">    <span class="dt">sum =</span> <span class="kw">attr</span>(.x, <span class="st">&quot;sum&quot;</span>),</a>
<a class="sourceLine" id="cb56-4" title="4">    <span class="dt">mean =</span> <span class="kw">attr</span>(.x, <span class="st">&quot;sum&quot;</span>) <span class="op">/</span><span class="st"> </span><span class="kw">length</span>(.x),</a>
<a class="sourceLine" id="cb56-5" title="5">    <span class="kw">vec_math_base</span>(.fn, .x, ...)</a>
<a class="sourceLine" id="cb56-6" title="6">  )</a>
<a class="sourceLine" id="cb56-7" title="7">}</a></code></pre></div>
</div>
<div id="meter-class" class="section level3">
<h3>Meter class</h3>
<p>To explore the infix arithmetic operators exposed by <code>vec_arith()</code> I’ll create a new class that represents a measurement in <code>meter</code>s:</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb57-1" title="1">new_meter &lt;-<span class="st"> </span><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb57-2" title="2">  <span class="kw">stopifnot</span>(<span class="kw">is.double</span>(x))</a>
<a class="sourceLine" id="cb57-3" title="3">  <span class="kw">new_vctr</span>(x, <span class="dt">class =</span> <span class="st">&quot;vctrs_meter&quot;</span>)</a>
<a class="sourceLine" id="cb57-4" title="4">}</a>
<a class="sourceLine" id="cb57-5" title="5"></a>
<a class="sourceLine" id="cb57-6" title="6">format.vctrs_meter &lt;-<span class="st"> </span><span class="cf">function</span>(x, ...) {</a>
<a class="sourceLine" id="cb57-7" title="7">  <span class="kw">paste0</span>(<span class="kw">format</span>(<span class="kw">vec_data</span>(x)), <span class="st">&quot; m&quot;</span>)</a>
<a class="sourceLine" id="cb57-8" title="8">}</a>
<a class="sourceLine" id="cb57-9" title="9"></a>
<a class="sourceLine" id="cb57-10" title="10">meter &lt;-<span class="st"> </span><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb57-11" title="11">  x &lt;-<span class="st"> </span><span class="kw">vec_cast</span>(x, <span class="kw">double</span>())</a>
<a class="sourceLine" id="cb57-12" title="12">  <span class="kw">new_meter</span>(x)</a>
<a class="sourceLine" id="cb57-13" title="13">}</a>
<a class="sourceLine" id="cb57-14" title="14"></a>
<a class="sourceLine" id="cb57-15" title="15">x &lt;-<span class="st"> </span><span class="kw">meter</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>)</a>
<a class="sourceLine" id="cb57-16" title="16">x</a>
<a class="sourceLine" id="cb57-17" title="17"><span class="co">#&gt; &lt;vctrs_meter[10]&gt;</span></a>
<a class="sourceLine" id="cb57-18" title="18"><span class="co">#&gt;  [1]  1 m  2 m  3 m  4 m  5 m  6 m  7 m  8 m  9 m 10 m</span></a></code></pre></div>
<p>Because <code>meter</code> is built on top of a double vector, basic mathematic operations work:</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb58-1" title="1"><span class="kw">sum</span>(x)</a>
<a class="sourceLine" id="cb58-2" title="2"><span class="co">#&gt; &lt;vctrs_meter[1]&gt;</span></a>
<a class="sourceLine" id="cb58-3" title="3"><span class="co">#&gt; [1] 55 m</span></a>
<a class="sourceLine" id="cb58-4" title="4"><span class="kw">mean</span>(x)</a>
<a class="sourceLine" id="cb58-5" title="5"><span class="co">#&gt; &lt;vctrs_meter[1]&gt;</span></a>
<a class="sourceLine" id="cb58-6" title="6"><span class="co">#&gt; [1] 5.5 m</span></a></code></pre></div>
<p>But we can’t do arithmetic:</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb59-1" title="1">x <span class="op">+</span><span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb59-2" title="2"><span class="co">#&gt; &lt;vctrs_meter&gt; + &lt;double&gt; is not permitted</span></a>
<a class="sourceLine" id="cb59-3" title="3"><span class="kw">meter</span>(<span class="dv">10</span>) <span class="op">+</span><span class="st"> </span><span class="kw">meter</span>(<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb59-4" title="4"><span class="co">#&gt; &lt;vctrs_meter&gt; + &lt;vctrs_meter&gt; is not permitted</span></a>
<a class="sourceLine" id="cb59-5" title="5"><span class="kw">meter</span>(<span class="dv">10</span>) <span class="op">*</span><span class="st"> </span><span class="dv">3</span></a>
<a class="sourceLine" id="cb59-6" title="6"><span class="co">#&gt; &lt;vctrs_meter&gt; * &lt;double&gt; is not permitted</span></a></code></pre></div>
<p>To allow these infix functions to work, we’ll need to provide <code>vec_arith()</code> generic. But before we do that, let’s think about what combinations of inputs we should support:</p>
<ul>
<li><p>It makes sense to add and subtract meters: that yields another meter. We can divide a meter by another meter (yielding a unitless number), but we can’t multiply meters (because that would yield an area.)</p></li>
<li><p>For a combination of meter and number multiplication and division by a number are acceptable. Addition and subtraction don’t make much sense as we, strictly speaking, are dealing with objects of different nature.</p></li>
</ul>
<p><code>vec_arith()</code> is another function that uses double dispatch, so as usual we start with a template.</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb60-1" title="1">vec_arith.vctrs_meter &lt;-<span class="st"> </span><span class="cf">function</span>(op, x, y, ...) {</a>
<a class="sourceLine" id="cb60-2" title="2">  <span class="kw">UseMethod</span>(<span class="st">&quot;vec_arith.vctrs_meter&quot;</span>, y)</a>
<a class="sourceLine" id="cb60-3" title="3">}</a>
<a class="sourceLine" id="cb60-4" title="4">vec_arith.vctrs_meter.default &lt;-<span class="st"> </span><span class="cf">function</span>(op, x, y, ...) {</a>
<a class="sourceLine" id="cb60-5" title="5">  <span class="kw">stop_incompatible_op</span>(op, x, y)</a>
<a class="sourceLine" id="cb60-6" title="6">}</a></code></pre></div>
<p>Then write the method for two meter objects. We use a switch statement to cover the cases we care about, and <code>stop_incompatible_op()</code> to throw an informative error message for everything else.</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb61-1" title="1">vec_arith.vctrs_meter.vctrs_meter &lt;-<span class="st"> </span><span class="cf">function</span>(op, x, y, ...) {</a>
<a class="sourceLine" id="cb61-2" title="2">  <span class="cf">switch</span>(</a>
<a class="sourceLine" id="cb61-3" title="3">    op,</a>
<a class="sourceLine" id="cb61-4" title="4">    <span class="st">&quot;+&quot;</span> =<span class="st"> </span>,</a>
<a class="sourceLine" id="cb61-5" title="5">    <span class="st">&quot;-&quot;</span> =<span class="st"> </span><span class="kw">new_meter</span>(<span class="kw">vec_arith_base</span>(op, x, y)),</a>
<a class="sourceLine" id="cb61-6" title="6">    <span class="st">&quot;/&quot;</span> =<span class="st"> </span><span class="kw">vec_arith_base</span>(op, x, y),</a>
<a class="sourceLine" id="cb61-7" title="7">    <span class="kw">stop_incompatible_op</span>(op, x, y)</a>
<a class="sourceLine" id="cb61-8" title="8">  )</a>
<a class="sourceLine" id="cb61-9" title="9">}</a>
<a class="sourceLine" id="cb61-10" title="10"></a>
<a class="sourceLine" id="cb61-11" title="11"><span class="kw">meter</span>(<span class="dv">10</span>) <span class="op">+</span><span class="st"> </span><span class="kw">meter</span>(<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb61-12" title="12"><span class="co">#&gt; &lt;vctrs_meter[1]&gt;</span></a>
<a class="sourceLine" id="cb61-13" title="13"><span class="co">#&gt; [1] 11 m</span></a>
<a class="sourceLine" id="cb61-14" title="14"><span class="kw">meter</span>(<span class="dv">10</span>) <span class="op">-</span><span class="st"> </span><span class="kw">meter</span>(<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb61-15" title="15"><span class="co">#&gt; &lt;vctrs_meter[1]&gt;</span></a>
<a class="sourceLine" id="cb61-16" title="16"><span class="co">#&gt; [1] 9 m</span></a>
<a class="sourceLine" id="cb61-17" title="17"><span class="kw">meter</span>(<span class="dv">10</span>) <span class="op">/</span><span class="st"> </span><span class="kw">meter</span>(<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb61-18" title="18"><span class="co">#&gt; [1] 10</span></a>
<a class="sourceLine" id="cb61-19" title="19"><span class="kw">meter</span>(<span class="dv">10</span>) <span class="op">*</span><span class="st"> </span><span class="kw">meter</span>(<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb61-20" title="20"><span class="co">#&gt; &lt;vctrs_meter&gt; * &lt;vctrs_meter&gt; is not permitted</span></a></code></pre></div>
<p>Next we write the pair of methods for arithmetic with a meter and a number. These are almost identical, but while <code>meter(10) / 2</code> makes sense, <code>2 / meter(10)</code> does not (as addition and subtraction).</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb62-1" title="1">vec_arith.vctrs_meter.numeric &lt;-<span class="st"> </span><span class="cf">function</span>(op, x, y, ...) {</a>
<a class="sourceLine" id="cb62-2" title="2">  <span class="cf">switch</span>(</a>
<a class="sourceLine" id="cb62-3" title="3">    op,</a>
<a class="sourceLine" id="cb62-4" title="4">    <span class="st">&quot;/&quot;</span> =<span class="st"> </span>,</a>
<a class="sourceLine" id="cb62-5" title="5">    <span class="st">&quot;*&quot;</span> =<span class="st"> </span><span class="kw">new_meter</span>(<span class="kw">vec_arith_base</span>(op, x, y)),</a>
<a class="sourceLine" id="cb62-6" title="6">    <span class="kw">stop_incompatible_op</span>(op, x, y)</a>
<a class="sourceLine" id="cb62-7" title="7">  )</a>
<a class="sourceLine" id="cb62-8" title="8">}</a>
<a class="sourceLine" id="cb62-9" title="9">vec_arith.numeric.vctrs_meter &lt;-<span class="st"> </span><span class="cf">function</span>(op, x, y, ...) {</a>
<a class="sourceLine" id="cb62-10" title="10">  <span class="cf">switch</span>(</a>
<a class="sourceLine" id="cb62-11" title="11">    op,</a>
<a class="sourceLine" id="cb62-12" title="12">    <span class="st">&quot;*&quot;</span> =<span class="st"> </span><span class="kw">new_meter</span>(<span class="kw">vec_arith_base</span>(op, x, y)),</a>
<a class="sourceLine" id="cb62-13" title="13">    <span class="kw">stop_incompatible_op</span>(op, x, y)</a>
<a class="sourceLine" id="cb62-14" title="14">  )</a>
<a class="sourceLine" id="cb62-15" title="15">}</a>
<a class="sourceLine" id="cb62-16" title="16"></a>
<a class="sourceLine" id="cb62-17" title="17"><span class="kw">meter</span>(<span class="dv">2</span>) <span class="op">*</span><span class="st"> </span><span class="dv">10</span></a>
<a class="sourceLine" id="cb62-18" title="18"><span class="co">#&gt; &lt;vctrs_meter[1]&gt;</span></a>
<a class="sourceLine" id="cb62-19" title="19"><span class="co">#&gt; [1] 20 m</span></a>
<a class="sourceLine" id="cb62-20" title="20"><span class="dv">10</span> <span class="op">*</span><span class="st"> </span><span class="kw">meter</span>(<span class="dv">2</span>) </a>
<a class="sourceLine" id="cb62-21" title="21"><span class="co">#&gt; &lt;vctrs_meter[1]&gt;</span></a>
<a class="sourceLine" id="cb62-22" title="22"><span class="co">#&gt; [1] 20 m</span></a>
<a class="sourceLine" id="cb62-23" title="23"><span class="kw">meter</span>(<span class="dv">20</span>) <span class="op">/</span><span class="st"> </span><span class="dv">10</span></a>
<a class="sourceLine" id="cb62-24" title="24"><span class="co">#&gt; &lt;vctrs_meter[1]&gt;</span></a>
<a class="sourceLine" id="cb62-25" title="25"><span class="co">#&gt; [1] 2 m</span></a>
<a class="sourceLine" id="cb62-26" title="26"><span class="dv">10</span> <span class="op">/</span><span class="st"> </span><span class="kw">meter</span>(<span class="dv">20</span>)</a>
<a class="sourceLine" id="cb62-27" title="27"><span class="co">#&gt; &lt;double&gt; / &lt;vctrs_meter&gt; is not permitted</span></a>
<a class="sourceLine" id="cb62-28" title="28"><span class="kw">meter</span>(<span class="dv">20</span>) <span class="op">+</span><span class="st"> </span><span class="dv">10</span></a>
<a class="sourceLine" id="cb62-29" title="29"><span class="co">#&gt; &lt;vctrs_meter&gt; + &lt;double&gt; is not permitted</span></a></code></pre></div>
<p>For completeness, we also need <code>vec_arith.vctrs_meter.MISSING</code> for the unary <code>+</code> and <code>-</code> operators:</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb63-1" title="1">vec_arith.vctrs_meter.MISSING &lt;-<span class="st"> </span><span class="cf">function</span>(op, x, y, ...) {</a>
<a class="sourceLine" id="cb63-2" title="2">  <span class="cf">switch</span>(op, </a>
<a class="sourceLine" id="cb63-3" title="3">    <span class="st">`</span><span class="dt">-</span><span class="st">`</span> =<span class="st"> </span>x <span class="op">*</span><span class="st"> </span><span class="dv">-1</span>,</a>
<a class="sourceLine" id="cb63-4" title="4">    <span class="st">`</span><span class="dt">+</span><span class="st">`</span> =<span class="st"> </span>x,</a>
<a class="sourceLine" id="cb63-5" title="5">    <span class="kw">stop_incompatible_op</span>(op, x, y)</a>
<a class="sourceLine" id="cb63-6" title="6">  )</a>
<a class="sourceLine" id="cb63-7" title="7">}</a>
<a class="sourceLine" id="cb63-8" title="8"><span class="op">-</span><span class="kw">meter</span>(<span class="dv">1</span>) </a>
<a class="sourceLine" id="cb63-9" title="9"><span class="co">#&gt; &lt;vctrs_meter[1]&gt;</span></a>
<a class="sourceLine" id="cb63-10" title="10"><span class="co">#&gt; [1] -1 m</span></a>
<a class="sourceLine" id="cb63-11" title="11"><span class="op">+</span><span class="kw">meter</span>(<span class="dv">1</span>) </a>
<a class="sourceLine" id="cb63-12" title="12"><span class="co">#&gt; &lt;vctrs_meter[1]&gt;</span></a>
<a class="sourceLine" id="cb63-13" title="13"><span class="co">#&gt; [1] 1 m</span></a></code></pre></div>
</div>
</div>
<div id="appendix-namespace-declarations" class="section level2">
<h2>Appendix: <code>NAMESPACE</code> declarations</h2>
<p>Defining S3 methods interactively is fine for iteration and exploration, but if your vector lives in a package, you also need to register the S3 methods by listing them in the <code>NAMESPACE</code> file. The namespace declarations are a little tricky because (e.g.) <code>vec_cast.vctrs_percent()</code> is both a generic function (which must be exported with <code>export()</code>) and an S3 method (which must be registered with <code>S3method()</code>).</p>
<p>This problem wasn’t considered in the design of roxygen2, so you have to be quite explicit:</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb64-1" title="1"><span class="co">#&#39; @method vec_cast vctrs_percent</span></a>
<a class="sourceLine" id="cb64-2" title="2"><span class="co">#&#39; @export</span></a>
<a class="sourceLine" id="cb64-3" title="3"><span class="co">#&#39; @export vec_cast.vctrs_percent</span></a>
<a class="sourceLine" id="cb64-4" title="4">vec_cast.vctrs_percent &lt;-<span class="st"> </span><span class="cf">function</span>(x, to, ...) {</a>
<a class="sourceLine" id="cb64-5" title="5">} </a></code></pre></div>
<p>You also need to register the individual double-dispatch methods. Again, this is harder than it should be because roxygen’s heuristics aren’t quite right. That means you need to describe the <code>@method</code> explicitly:</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb65-1" title="1"><span class="co">#&#39; @method vec_cast.binned double</span></a>
<a class="sourceLine" id="cb65-2" title="2"><span class="co">#&#39; @export</span></a>
<a class="sourceLine" id="cb65-3" title="3">vec_cast.binned.double &lt;-<span class="st"> </span><span class="cf">function</span>(x, y, ...) {</a>
<a class="sourceLine" id="cb65-4" title="4">}</a></code></pre></div>
<p>Hopefully future versions of roxygen will make these exports less painful.</p>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
